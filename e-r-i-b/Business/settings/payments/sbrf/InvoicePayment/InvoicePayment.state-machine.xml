<?xml version="1.0" encoding="windows-1251"?>

<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="../../../../../Settings/schemas/state-machine.xsd">

    <states inital-state="INITIAL" description="Машина состояний оплаты инвойса (счета)" saveNodeInfo="true">
        <state id="INITIAL" description="Вы сохранили, но еще не подтвердили платеж."
               client-form="/private/payments/payment.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="CONFIRM" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DocumentSumValidationHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SimpleBusinessDocumentDateAction"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.basket.invoice.PostConfirmInvoiceHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED"/>
                </event>
                <event name="DOUNKNOW" type="client">
                    <next-states default="UNKNOW"/>
                </event>
                <event name="DOWAITCONFIRM" description="Перевод документа в ожидание дополнительной обработки" type="client">
                    <next-states default="WAIT_CONFIRM">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SimpleBusinessDocumentDateAction"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.basket.invoice.PostConfirmInvoiceHandler"/>
                        </handlers>
                    </next-states>
                </event>
            </events>
        </state>

        <state id="DISPATCHED" description="Оплата инвойса (счета) подтверждена и передана на обработку в банк."
               client-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="EXECUTE" description="Подтверждение документа системой" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.basket.invoice.UpdateInvoiceStatusHandler">
                            <parameter name="status" value="INACTIVE"/>
                        </handler>
                    </handlers>
                    <next-states default="EXECUTED"/>
                </event>
                <event name="EXECUTE" description="Подтверждение документа сотрудником" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.basket.invoice.UpdateInvoiceStatusHandler">
                            <parameter name="status" value="INACTIVE"/>
                        </handler>
                    </handlers>
                    <next-states default="EXECUTED"/>
                </event>
                <event name="REFUSE" description="Отказ документа системой" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.basket.invoice.UpdateInvoiceStatusHandler">
                            <parameter name="status" value="INACTIVE"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                    </handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ документа сотрудником" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.basket.invoice.UpdateInvoiceStatusHandler">
                            <parameter name="status" value="INACTIVE"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                    </handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DOUNKNOW" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.basket.invoice.UpdateInvoiceStatusHandler">
                            <parameter name="status" value="ERROR"/>
                        </handler>
                    </handlers>
                    <next-states default="UNKNOW"/>
                </event>
            </events>
        </state>

        <state id="WAIT_CONFIRM" description="Документ, ожидающий дополнительного подтверждения"
              client-form="/private/payments/view.do"
              system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="DOUNKNOW" description="таймаут" type="employee">
                    <next-states default="UNKNOW"/>
                </event>
                <event name="CONFIRM" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SimpleBusinessDocumentDateAction"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.basket.invoice.PostConfirmInvoiceHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED"/>
                </event>

                <event name="REFUSE" description="Отклонить заявку" type="employee">
                    <next-states default="REFUSED"/>
                </event>
            </events>
        </state>

        <state id="UNKNOW" description="Статус документа не определен. Пожалуйста, обратитесь в контактный центр банка."
               client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="SPECIFY" description="Уточнение состояния документа" type="employee" lock="true">
                    <next-states default="UNKNOW">
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.ESBBillingPaymentCondition" state="DISPATCHED" description="Оплата инвойса (счета) подтверждена и передана на обработку в банк.">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.basket.invoice.UpdateInvoiceStatusHandler">
                                    <parameter name="status" value="PAID"/>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                             </handlers>
                            <!--фильтруем документы, отправленные в подразделение, обслуживаемое шиной-->
                            <enabled class="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.DocumentOfficeESBSupportedFilter"/>
                        </next-state>
                    </next-states>
                </event>
            </events>
        </state>

        <state id="EXECUTED" description="Платеж успешно принят на исполнение в банке."
               client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
        </state>

        <state id="REFUSED" description="Вам отказано в исполнении операции по какой-либо причине."
               client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
        </state>
    </states>
</config>