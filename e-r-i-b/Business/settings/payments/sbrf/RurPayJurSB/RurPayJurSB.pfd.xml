<?xml version="1.0" encoding="windows-1251"?>
<payment-form name="RurPayJurSB" description="Оплата услуг"
              detailedDescription="Для продолжения совершения платежа заполните поля данной формы и нажмите на кнопку «Оплатить»."
              confirmDescription="Платеж успешно отправлен в банк. После его обработки средства будут списаны с Вашего счета и переведены на счет получателя. Спасибо, что Вы воспользовались «Сбербанк Онлайн»!"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:noNamespaceSchemaLocation="../../PaymentForm.xsd">
	<implementation class="com.rssl.phizic.business.documents.payments.JurPayment"/>
	<template-implementation class="com.rssl.phizic.business.documents.templates.impl.PaymentSystemTransferTemplate"/>
	<statemachine name="BillingPaymentStateMachine"/>
    <extended-metadata-loader
            class="com.rssl.phizic.business.payments.forms.meta.receivers.PaymentSystemPaymentMetadataLoader"/>
	<fields>
		<field  name="documentNumber"
                description="Номер документа"
                type="string"
                source="document-number"
                signable="true">
		</field>

        <field  name="billingDocumentNumber"
                source="billing-document-number"
                type = "string"
                description="Номер операции в БС"
                signable="true">
        </field>

		<field  name="documentDate"
                description="Дата документа"
                type="date"
                source="document-date"
                signable="true">
        </field>

        <field  name="documentTime"
				description="Время документа"
				source="document-time"
                type="string">
        </field>

        <field  name="fromResource"
                source="extra-parameters/parameter[@name='from-resource']/@value"
                description="Источник списания средств: счет, карта"
                type="resource">

            <validators>
                <validator mode="pre-template|template|by-template|prepare|document|mobile|prepare-long-offer" class="com.rssl.common.forms.validators.RequiredFieldValidator"/>
                <validator mode="draft-template|pre-template|template|by-template|prepare|document|prepare-long-offer|long-offer" class="com.rssl.phizic.business.documents.AllowedExternalJurAccountPaymentValidator"/>
                <validator mode="pre-template|template|by-template|prepare|document|mobile|prepare-long-offer" class="com.rssl.phizic.business.payments.forms.validators.CheckResourceVisibilityValidator"/>
            </validators>
        </field>

        <field  name="fromResourceType"
                source="extra-parameters/parameter[@name='from-resource-type']/@value"
                description="Тип источника списания средств: счет, карта"
                type="string"
                value="form.fromResource==null?null:form.fromResource.getClass().getName()">
        </field>

		<field  name="fromAccountSelect"
                description="Счет/карта списания"
                type="string"
                source="payer-account"
                signable="true"
                value="form.fromResource==null?null:form.fromResource.getNumber()">
		</field>

        <field  name="fromAccountType"
                source="extra-parameters/parameter[@name='from-account-type']/@value"
                description="Тип (описание) источника списания"
                type="string"
                signable="true"
                value="form.fromResource==null?null:form.fromResource.getValue().getDescription()">
        </field>

        <field  name="fromAccountName"
                source="extra-parameters/parameter[@name='from-account-name']/@value"
                description="Наименование источника списания"
                type="string"
                signable="true"
                value="form.fromResource==null?null:form.fromResource.getName()">
        </field>

        <field  name="exactAmount"
                description="Сумма списания (зачисления)"
                source="exact-amount"
                type="string">
        </field>

        <field  name="amountCurrency"
                description="Валюта"
                source="amount-currency"
                type="string"
                value="form.fromAccountSelect==null?null:form.fromResource.getCurrency().getCode()"
                signable="true">
        </field>

        <field  name="fromResourceCurrency"
                description="Валюта"
                source="extra-parameters/parameter[@name='from-resource-currency']/@value"
                type="string"
                value="form.fromAccountSelect==null?null:form.fromResource.getCurrency().getCode()"
                signable="true">
        </field>

        <field  name="destinationCurrency"
                description="Валюта"
                source="destination-amount-currency"
                type="string"
                signable="true">
        </field>

        <field  name="codeService"
                description="Идентификатор услуги в биллинговой системе"
                type="string"
                subType="static"
                source="extra-parameters/parameter[@name='codeService']/@value">
        </field>

        <field  name="nameService"
                description="Наименование услуги в биллинговой системе"
                type="string"
                subType="static"
                source="extra-parameters/parameter[@name='nameService']/@value">
        </field>

        <field  name="phoneNumber"
                description="Телефон для обращений клиентов"
                type="string"
                subType="static"
                source="extra-parameters/parameter[@name='receiver-phone-number']/@value">
        </field>

        <field  name="authorizeCode"
                description="Код авторизации"
                type="string"
                source="extra-parameters/parameter[@name='AUTHORIZE_CODE']/@value">
        </field>

        <!--Данные получателя-->
        <field  name="recipient"
                description="Идентифкатор поставщика услуг"
                type="long"
                subType="static"
                source="recipient">
        </field>

        <field  name="receiverId"
                description="Внешний идентификатор получателя"
                type="string"
                subType="static"
                source="receiverId">
        </field>

        <field  name="billingCode"
                description="Идентфикатор билинговой системы"
                type="string"
                subType="static"
                source="extra-parameters/parameter[@name='provider-billing-code']/@value">
        </field>

        <field  name="receiverName"
                description="Наименование получателя"
                type="string"
                subType="static"
                source="receiver-name"
                signable="true">
        </field>

        <field  name="nameOnBill"
                description="Наименование получателя, выводимое в чеке"
                type="string"
                subType="static"
                source="extra-parameters/parameter[@name='name-on-bill']/@value">
        </field>

        <field  name="receiverDescription"
                source="extra-parameters/parameter[@name='receiver-description']/@value"
                subType="static"
                description="Описание получателя"
                type="string">
        </field>

		<field  name="receiverAccount"
                description="Счет зачисления"
                type="string"
                subType="static"
                source="receiver-account"
                signable="true">
        </field>

		<field  name="receiverINN"
                description="ИНН"
                type="string"
                subType="static"
                source="extra-parameters/parameter[@name='receiver-inn']/@value"
                signable="true">
        </field>

		<field  name="receiverKPP"
                description="КПП"
                type="string"
                subType="static"
                source="extra-parameters/parameter[@name='receiver-kpp']/@value"
                signable="true">
        </field>

        <field  name="receiverBIC"
                description="БИК"
                type="string"
                subType="static"
                source="extra-parameters/parameter[@name='receiver-bic']/@value"
                signable="true">
        </field>

		<field  name="receiverBankName"
                description="Наименование банка Получателя"
                type="string"
                subType="static"
                source="extra-parameters/parameter[@name='receiver-bank']/@value"
                signable="true">
        </field>

		<field  name="receiverCorAccount"
                description="Кор.Счет"
                type="string"
                subType="static"
                source="extra-parameters/parameter[@name='receiver-cor-account']/@value"
                signable="true">
        </field>

        <field  name="commission"
                description="Сумма коммисии"
                source="commission"
                type="money"
                signable="true"
                value="'Значение только для чтения: не должно приходить от клиента и сеттиться в БД'">
        </field>

        <field  name="commissionCurrency"
                description="Сумма коммисии"
                source="commission-currency"
                type="string"
                signable="true"
                value="'Значение только для чтения: не должно приходить от клиента и сеттиться в БД'">
        </field>

		<field  name="admissionDate"
                description="Плановая дата исполнения платежа"
                source="admission-date"
                type="date"
                signable="false">
        </field>

		<field  name="operationCode"
                description="Код валютной операции"
                type="string"
                subType="static"
                source="extra-parameters/parameter[@name='operation-code']/@value"
                signable="true"
                value="((form.receiverAccount != null &amp;&amp; (form.receiverAccount.substring(0,5) == '40820' || form.receiverAccount.substring(0,3) == '426')) || (form.fromAccountSelect != null &amp;&amp; (form.fromAccountSelect.substring(0,5) == '40820' || form.fromAccountSelect.substring(0,3) == '426'))) ? '{VO99090}' : ''"/>

		<field  name="state"
                source="state"
                description="Статус платежа"
                type="string">
        </field>

		<field  name="promoCode"
                source="promoCode"
                description="Промо-код"
                type="string">
        </field>

		<field  name="operationDate"
                source="operation-date-short-year"
                description="Дата отправки платежа"
                type="string">
        </field>

        <field  name="operationTime"
			    source="operation-time"
			    description="Время отправки платежа"
			    type="string">
        </field>

		<field  name="chargeOffDate"
                source="execution-date"
                description="Дата исполнения платежа"
                type="date">
        </field>

        <field  name="bankDetails"
                description="Банковские реквизиты"
                type="boolean"
                subType="static"
                source="extra-parameters/parameter[@name='bank-details']/@value">
        </field>

        <field  name="cardAccountFrom"
                source="cardAccountFrom"
                description="Номер счета карты списания"
                value="xpath:phiz:document('active-cards.xml')/entity-list/entity[@key=$fromAccountSelect]/field[@name='cardAccount']"/>

        <field  name="fromAccountNumber"
                source="fromAccountNumber"
                description="Номер счета списания"
                value="form.fromResourceType == 'com.rssl.phizic.business.resources.external.CardLink' ? form.cardAccountFrom : form.fromAccountSelect"/>

        <!-- Поля автоплатежа -->
        <field  name="autoSubType"
                source="extra-parameters/parameter[@name='auto-sub-type']/@value"
                description="Тип автоплатежа"
                type="string"
                signable="true">

            <validators>
                <validator mode="long-offer" class="com.rssl.common.forms.validators.RequiredFieldValidator"/>
            </validators>
        </field>

        <field  name="autoSubEventType"
                source="extra-parameters/parameter[@name='long-offer-event-type']/@value"
                description="Тип события исполнения автоплатежа"
                type="string"
                signable="true">

            <validators>
                <validator mode="long-offer" class="com.rssl.common.forms.validators.RequiredFieldValidator"/>
            </validators>
        </field>

        <field  name="autoSubSumType"
                description="Тип суммы исполения регулярного платежа"
                type="string"
                source="extra-parameters/parameter[@name='long-offer-sum-type']/@value"
                value="form.autoSubType=='ALWAYS'?'FIXED_SUMMA_IN_RECIP_CURR':'BY_BILLING'"
                signable="true">
        </field>

        <field  name="autoSubName"
                description="Название регулярного платежа"
                type="string"
                source="extra-parameters/parameter[@name='auto-sub-friendy-name']/@value"
                signable="true">

             <validators>
                <validator mode="long-offer" class="com.rssl.common.forms.validators.RequiredFieldValidator"/>
                <validator mode="long-offer" class="com.rssl.common.forms.validators.RegexpFieldValidator">
                    <message   text="Наименование автоплатежа не должно превышать 20 символов. Пожалуйста, введите другое название."/>
                    <parameter name="regexp">^.{0,20}$</parameter>
                </validator>
                <validator mode="long-offer" class="com.rssl.common.forms.validators.RegexpFieldValidator">
                    <message text="Вы указали недопустимые символы. В наименовании можно использовать буквы лат. алфавита, кириллицы, пробел, цифры, ?, !, *, &quot;, двоеточие, точку, запятую, точку с запятой или тире."/>
                    <parameter name="regexp">[^\|&amp;&amp;a-zA-Z|а-я\u0451А-Я\u0401|0-9|\\|\*|,|\.|;|\!|\?|:|"|\-| ]*</parameter>
                </validator>
            </validators>
        </field>
        
        <field  name="nextPayDateAlways"
                description="Дата ближайшего платежа"
                type="date"
                source="extra-parameters/parameter[@name='auto-sub-next-pay-date']/@value"
                enabled="form.autoSubType == 'ALWAYS'"
                signable="true">

            <validators>
                <validator mode="long-offer" class="com.rssl.common.forms.validators.RequiredFieldValidator" />
                <validator mode="long-offer" class="com.rssl.common.forms.validators.DateFieldValidator" />
            </validators>
        </field>

        <field  name="alwaysAmount"
                description="Сумма"
                type="money"
                source="destination-amount"
                enabled="form.autoSubType == 'ALWAYS'"
                signable="true">

            <validators>
                <validator mode="long-offer" class="com.rssl.common.forms.validators.RequiredFieldValidator" />
                <validator mode="long-offer" class="com.rssl.common.forms.validators.MoneyFieldValidator">
					<message text="Пожалуйста, укажите сумму, которую необходимо перевести. Например, 320,66"/>
                    <parameter name="minValue">0.01</parameter>
                    <parameter name="maxValue">999999999999999.99</parameter>
                </validator>
            </validators>
        </field>

        <field  name="alwaysAmountCurrency"
                source="destination-amount-currency"
                description="Валюта суммы списания при регулярном платеже"
                type="string"
                enabled="form.autoSubType == 'ALWAYS'"
                signable="true"
                value="'RUB'">
        </field>

        <!-- по выставленному счету -->
        <field  name="nextPayDateInvoice"
                description="Ожидаемая дата оплаты счета"
                type="date"
                source="extra-parameters/parameter[@name='auto-sub-next-pay-date']/@value"
                enabled="form.autoSubType == 'INVOICE'"
                signable="true">

            <validators>
                <validator mode="long-offer" class="com.rssl.common.forms.validators.RequiredFieldValidator" />
                <validator mode="long-offer" class="com.rssl.common.forms.validators.DateFieldValidator" />
            </validators>
        </field>

        <field  name="invoiceMaxAmount"
                description="Максимальный размер платежа"
                type="money"
                source="extra-parameters/parameter[@name='auto-sub-invoice-max-decimal']/@value"
                enabled="form.autoSubType=='INVOICE'"
                signable="true">

            <validators>
                <validator mode="long-offer" class="com.rssl.common.forms.validators.MoneyFieldValidator">
					<message text="Пожалуйста, укажите сумму, которую необходимо перевести. Например, 320,66"/>
                    <parameter name="minValue">0.01</parameter>
                    <parameter name="maxValue">999999999999999.99</parameter>
                </validator>
            </validators>
        </field>

        <field  name="invoiceMaxAmountCurrency"
                source="extra-parameters/parameter[@name='auto-sub-invoice-max-currency']/@value"
                description="Валюта максимальной суммы платежа в месяц"
                type="string"
                enabled="form.autoSubType == 'INVOICE'"
                signable="true"
                value="'RUB'">
        </field>

        <field  name="isWithCommission"
                source="extra-parameters/parameter[@name='auto-sub-with-commision']/@value"
                description="c комиссией"
                type="boolean">
        </field>

        <field  name="personRegionName"
                source="extra-parameters/parameter[@name='person-region-name']/@value"
                description="Выбранный пользователем регион"
                type="string">
        </field>

        <field  name="fromResourceLink"
                source="extra-parameters/parameter[@name='from-resource-link']/@value"
                description="Ссылка на ресурс списания"
                type="string"
                value="form.fromResource==null?null:form.fromResource.getCode()">
        </field>

        <field  name="reasonForAdditionalConfirm"
                source="extra-parameters/parameter[@name='reason-for-additional-confirm']/@value"
                description="Причина дополнительного подтверждения платежа в КЦ"
                type="string">
        </field>

        <field  name="checkStatusCountResult"
                source="extra-parameters/parameter[@name='check-status-count-result']/@value"
                description="Признак превышения допустимого значения проверок статуса платежа во ВС"
                type="boolean">
        </field>

        <field  name="dictFieldId"
                description="Получатель"
                type="string"
                source="extra-parameters/parameter[@name='dict-field-id']/@value">
        </field>
	</fields>

	<form-validators>
		<form-validator class="com.rssl.phizic.business.payments.forms.validators.AccountKeyValidator">
			<message text="Вы неправильно указали счет получателя. Пожалуйста, проверьте номер счета. "/>
			<field-ref name="receiverBIC">receiverBIC</field-ref>
			<field-ref name="receiverAccount">receiverAccount</field-ref>
		</form-validator>

		<form-validator mode="draft-template|by-template|prepare|document|mobile" class="com.rssl.phizic.business.payments.forms.validators.PaymentCurrencyPermittedValidator"
                enabled="form.fromResourceType == 'com.rssl.phizic.business.resources.external.AccountLink'">
            <message text="Вы не можете оплатить услуги со счета в иностранной валюте. Пожалуйста, выберите рублевый счет"/>
            <field-ref name="amountCurrency">amountCurrency</field-ref>
            <parameter name="currencies">RUB;RUR</parameter>
        </form-validator>

        <form-validator mode="long-offer" class="com.rssl.common.forms.validators.DateTimeCompareValidator" enabled="form.autoSubType == 'ALWAYS'">
            <message text="Дата ближайшего платежа не может быть меньше текущей даты"/>
            <field-ref name="from_date">nextPayDateAlways</field-ref>
            <field-ref name="from_time"/>
            <field-ref name="to_date"/>
            <field-ref name="to_time"/>
            <parameter name="curDate">to_cleartime</parameter>
            <parameter name="operator">ge</parameter>
        </form-validator>

        <form-validator mode="long-offer" class="com.rssl.common.forms.validators.DateTimeCompareValidator" enabled="form.autoSubType == 'INVOICE'">
            <message text="Ожидаемая дата оплаты счета не может быть меньше текущей даты"/>
            <field-ref name="from_date">nextPayDateInvoice</field-ref>
            <field-ref name="from_time"/>
            <field-ref name="to_date"/>
            <field-ref name="to_time"/>
            <parameter name="curDate">to_cleartime</parameter>
            <parameter name="operator">ge</parameter>
        </form-validator>

        <form-validator mode="long-offer" class="com.rssl.phizic.business.payments.forms.validators.CheckValuesAlwaysAutoPayValidator" enabled="form.autoSubType == 'ALWAYS' &amp;&amp; form.recipient!=null">
            <field-ref name="recipient">recipient</field-ref>
            <field-ref name="sellAmount">alwaysAmount</field-ref>
        </form-validator>

        <form-validator class="com.rssl.phizic.business.payments.forms.validators.FromResourceFilterValidator"
            enabled="form.fromResourceType == 'com.rssl.phizic.business.resources.external.AccountLink'">
            <message text="Вы не можете создать платеж по выбранному счету. Пожалуйста, создайте новый платеж."/>
			<field-ref name="fromResource">fromResource</field-ref>
		</form-validator>

        <form-validator class="com.rssl.phizic.business.payments.forms.validators.FromResourceFilterValidator"
            enabled="form.fromResourceType == 'com.rssl.phizic.business.resources.external.CardLink'">
            <message text="Вы не можете создать платеж по выбранной карте. Пожалуйста, создайте новый платеж."/>
			<field-ref name="fromResource">fromResource</field-ref>
		</form-validator>

        <form-validator  mode="long-offer|draft-template|pre-template|template|by-template|prepare|document|mobile" class="com.rssl.phizic.business.payments.forms.validators.BillingPaymentChargeOffCardValidator">
            <message text="Вы не можете создать платеж по выбранной карте. Пожалуйста, выберите другую карту."/>
			<field-ref name="fromResource">fromResource</field-ref>
            <field-ref name="recipient">recipient</field-ref>
        </form-validator>

        <!--ЕРМБ. Проверка карты отправителя: Карта не должна быть виртуальной-->
        <form-validator mode="sms" class="com.rssl.phizic.business.payments.forms.validators.CheckVirualCardValidator"
                        enabled="form.fromResourceType == 'com.rssl.phizic.business.resources.external.CardLink'">
            <message text="Операция не выполнена. Была указана виртуальная карта. Для совершения операции укажите в запросе другую карту для списания."/>
            <field-ref name="resource">fromResource</field-ref>
        </form-validator>

        <!--ЕРМБ. Проверка карты отправителя: Нельзя производить активные операции с дополнительной карты, выпущенной на имя третьего лица-->
        <form-validator mode="sms" class="com.rssl.phizic.business.payments.forms.validators.CardNotAdditionalClientToOtherValidator"
                        enabled="form.fromResourceType == 'com.rssl.phizic.business.resources.external.CardLink'">
            <message text="Операция не выполнена. Недопустимый платеж с карты, выпущенной другому лицу. Для проведения платежа укажите в запросе другую карту для списания."/>
            <field-ref name="resource">fromResource</field-ref>
        </form-validator>

    </form-validators>
</payment-form>