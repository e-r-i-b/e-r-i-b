<?xml version="1.0" encoding="windows-1251"?>

<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="../../schemas/state-machine.xsd">

    <states name="BillingPaymentStateMachine" inital-state="INITIAL" description="машина состояний биллингового платежа" saveNodeInfo="true">

        <sequences-handlers>
            <sequence name="confirm">
                <handler class="com.rssl.phizic.business.payments.forms.meta.DisallowExternalAccountPaymentHandler"/>
                <handler class="com.rssl.phizic.business.documents.payments.handlers.OutsidePaymentFromTemplateHandler"/>
                <handler class="com.rssl.phizic.business.payments.ValidatePaymentAccountHandler">
                    <parameter name="checkType" value="payer"/>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler"/>
                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckCommissionSumAction"/>
                <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.CheckProviderServicePaymentHandler"/>
                <handler class="com.rssl.phizic.business.payments.forms.meta.DocumentSumValidationHandler"/>
                <handler class="com.rssl.phizic.business.payments.ValidateAutoPaymentStartDateHandler"/>
            </sequence>
            <sequence name="initialLongOffer_save">
                <handler class="com.rssl.phizic.business.payments.ValidatePaymentAmountAction"/>
                <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultGateValidationHandler"/>
            </sequence>
        </sequences-handlers>

         <sequences-next-states>
            <sequence name="confirm">
                <!--заявка на создание автоплатежа с карты должна переходить в статус DISPATCHED-->
                <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.AutoSubscriptionCondition" state="DISPATCHED" description="Заявка на создание автоплатежа подтверждена и передана на обработку в банк.">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DisallowAdditionalCardPaymentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SimpleBusinessDocumentDateAction"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SetAutopayNumberHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                        <!-- сброс текстовки -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.ReceiverNameByTemplateSaveHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.filters.ByTemplatePaymentFilter"/>
                        </handler>
                     </handlers>
                </next-state>

                <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.MQIntegrationDocumentCondition" state="EXECUTED">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SimpleBusinessDocumentDateAction"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.AddOrUpdateReminderStateHandler"/>
                        <!-- установка сообщения о сроках исполнения платежа -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                            <parameter name="key" value="operation.tomorrow.message"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SavePaymentInvoiceMessageHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.ReceiverNameByTemplateSaveHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.filters.ByTemplatePaymentFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                            <parameter name="state" value="EXECUTED"/>
                        </handler>
                    </handlers>
                </next-state>

                <!--сообщения IQW не должны учитывать время приема документов, для онлайн платежей переходим в EXECUTE-->
                <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.OnlineIQWaveBillingPaymentCondition" state="EXECUTED">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SimpleBusinessDocumentDateAction"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.AddOrUpdateReminderStateHandler"/>
                        <!-- установка сообщения о сроках исполнения платежа -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                            <parameter name="key" value="operation.tomorrow.message"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SavePaymentInvoiceMessageHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.ReceiverNameByTemplateSaveHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.filters.ByTemplatePaymentFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                            <parameter name="state" value="EXECUTED"/>
                        </handler>
                    </handlers>
                </next-state>

                <!--сообщения IQW не должны учитывать время приема документов-->
                <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.IQWaveBillingPaymentCondition" state="DISPATCHED">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SimpleBusinessDocumentDateAction"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.AddOrUpdateReminderStateHandler"/>
                        <!-- установка сообщения о сроках исполнения платежа -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                            <parameter name="key" value="operation.payment.message"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SavePaymentInvoiceMessageHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.ReceiverNameByTemplateSaveHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.filters.ByTemplatePaymentFilter"/>
                        </handler>
                     </handlers>
                </next-state>
                <!--Остальные платежи учитывают время приема-->
                <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.DelayedStateCondition" state="DELAYED_DISPATCH">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment;
                                                                   com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                            <parameter name="datePropertyName" value="admissionDate"/>
                            <parameter name="datePropertyType" value="java.util.Calendar"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.AddOrUpdateReminderStateHandler"/>
                        <!-- сброс текстовки -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SavePaymentInvoiceMessageHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.ReceiverNameByTemplateSaveHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.filters.ByTemplatePaymentFilter"/>
                        </handler>
                    </handlers>
                </next-state>
                <!--сообщения через шину - онлайн-->
                <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.ESBBillingPaymentCondition" state="EXECUTED"> <!--store="ERIB"-->
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DisallowAdditionalCardPaymentHandler"/>
                        <!--проверяем ограничения на сумму платежа-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SimpleBusinessDocumentDateAction"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.AddOrUpdateReminderStateHandler"/>
                        <!-- установка сообщения о сроках исполнения платежа -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                            <parameter name="key" value="operation.tomorrow.message"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SavePaymentInvoiceMessageHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.ReceiverNameByTemplateSaveHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.filters.ByTemplatePaymentFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.externalPayments.UpdateUECOrderState"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="CreditReportPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                            <parameter name="state" value="EXECUTED"/>
                        </handler>
                     </handlers>
                </next-state>
            </sequence>

            <sequence name="confirm_employee">
                <!-- переходим в состояние ОТКАЗАН, если сработали ограничения на сумму платежа. -->
                <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.NotPassedJurPaymentSumRestrictionCondition" state="REFUSED">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                    </handlers>
                </next-state>
                <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.AutoSubStartDateExpiredCondition" state="REFUSED" description="Дата начала действия платежа меньше даты подтверждения.">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                    </handlers>
                </next-state>
                <sequence-next-states-ref name="confirm"/>
            </sequence>
            <sequence name="draft_save">
                <!-- переходим в статус INITIAL_LONG_OFFER подготовленный в билинге платеж для заполнения параметров шинного автоплатежа -->
                <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LongOfferBillingPaymentRequisitesSufficientCondition" state="INITIAL_LONG_OFFER">
                    <!--для полностью заполеннного документа выполянем действия-->
                    <handlers>
                        <!--считаем комисиию-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.BillingPaymentCommissionSaveHandler"/>
                        <!--валидируем в гейте-->
                        <handler  class="com.rssl.phizic.business.payments.forms.meta.DefaultGateValidationHandler"/>
                        <!-- Проверка непревышения введенной суммы отстатка на карте с учетом  возможности разности валют -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DocumentSumValidationHandler"/>
                        <!--сохраняем назначение платежа-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.PaymentSystemPaymentGroundSaveHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.systems.AccountPaymentSystemPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.AutoPaymentNextPayDateAction"/>
                    </handlers>
                </next-state>

                <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.OfflineBillingPaymentRequisitesSufficientCondition" state="OFFLINE_SAVED">
                    <!--для полностью заполеннного документа выполянем действия-->
                    <handlers>

                        <!--проверяем ограничения на сумму платежа-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.BarsReceiverNameHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.BarsReceiverNameHandlerFilter">
                                <parameter name="className1" value="com.rssl.phizic.gate.payments.systems.AccountPaymentSystemPayment"/>
                                <parameter name="className2" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment"/>
                            </enabled>
                        </handler>
                        <!-- Проверка непревышения введенной суммы отстатка на карте с учетом  возможности разности валют -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DocumentSumValidationHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.NotAirlineReservationDocumentFilter"/>
                        </handler>
                        <!--сохраняем назначение платежа-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.PaymentSystemPaymentGroundSaveHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.systems.AccountPaymentSystemPayment"/>
                            </enabled>
                        </handler>
                    </handlers>
                </next-state>

                <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.BillingPaymentRequisitesSufficientCondition" state="SAVED">
                    <!--для полностью заполеннного документа выполянем действия-->
                    <handlers>
                        <!--считаем комисиию-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.BillingPaymentCommissionSaveHandler"/>
                        <!--проверяем ограничения на сумму платежа-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                        <!--валидируем в гейте-->
                        <handler  class="com.rssl.phizic.business.payments.forms.meta.DefaultGateValidationHandler"/>
                         <!-- -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.BarsReceiverNameHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.BarsReceiverNameHandlerFilter">
                                <parameter name="className1" value="com.rssl.phizic.gate.payments.systems.AccountPaymentSystemPayment"/>
                                <parameter name="className2" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment"/>
                            </enabled>
                        </handler>
                        <!-- Проверка непревышения введенной суммы отстатка на карте с учетом  возможности разности валют -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DocumentSumValidationHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.NotAirlineReservationDocumentFilter"/>
                        </handler>
                        <!--сохраняем назначение платежа-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.PaymentSystemPaymentGroundSaveHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.systems.AccountPaymentSystemPayment"/>
                            </enabled>
                        </handler>
                    </handlers>
                </next-state>
            </sequence>
        </sequences-next-states>

        <state id="INITIAL" description="Вы создали, но еще не сохранили документ"
            client-form="/private/payments/servicesPayments/edit.do"
            employee-form="/autopayment/servicesPayments.do"
            system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="INITIAL" description="Редактирование документа клиентом" type="client">
                    <next-states default="INITIAL"/>
                </event>
                <event name="SAVE" description="Сохранение документа клиентом"  type="client" lock="true">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DisallowAdditionalCardPaymentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.mobilebank.CheckChargeOffCardToMobilBankHandler">
                            <parameter name="warning-message" value="Вы не сможете получать SMS-сообщения об операциях по автоплатежу, потому что к карте списания не подключена услуга «Мобильный банк». Если Вам не нужно SMS-информирование по данному автоплатежу, то подтвердите операцию."/>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckMobileServiceProviderHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ApplicationIsMobileFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckSocialServiceProviderHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ApplicationIsSocialFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckATMServiceProviderHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ApplicationIsATMFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.CheckEnteredCardForEmployeeLoginedByCardHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.CheckProviderServicePaymentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.ServiceProviderInfoSaveHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.AutoSubNotKeyFieldCleanHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedBillingPaymentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment"/>
                            </enabled>
                        </handler>
                        <!-- добавляем в платёж доп.поля из заказа (если платёж внешний) -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.externalPayments.PrepareUECPaymentHandler"/>
                        <!--добвление доп. полей для платежей по штрих-коду-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RegionTbCodeBillingPaymentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ApplicationIsApiFilter"/>
                        </handler>
                        <!--вызываем метод подготовки биллингового платежа. по его результатам в раширенных полях может появиться доп информация-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.PrepareBillingOfflineSupportedHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.BarCodePaymentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ApplicationIsApiFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PanelBlockIdHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbBillingPaymentRequisitesSufficientHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckBillingActivesForPaymentByTemplateHandler"/>
                    </handlers>

                    <!--по умолчанию считаем, что есть что еще заполнять: переводим в состояние частично заполен(черновик)-->
                    <next-states default="DRAFT">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.AutoSubByInvoceSubEntityRequisitesSufficientCondition" state="SAVED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DisallowAdditionalCardPaymentHandler"/>
                                <!--считаем комисиию-->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.BillingPaymentCommissionSaveHandler"/>
                                <!--валидируем в гейте-->
                                <handler  class="com.rssl.phizic.business.payments.forms.meta.DefaultGateValidationHandler"/>
                                <!--сохраняем назначение платежа-->
                                <sequence-handlers-ref name="initialLongOffer_save"/>
                                <handler class="com.rssl.phizic.business.ext.sbrf.mobilebank.CheckChargeOffCardToMobilBankHandler">
                                    <parameter name="warning-message" value="Вы не сможете получать SMS-сообщения об операциях по автоплатежу, потому что к карте списания не подключена услуга «Мобильный банк». Если Вам не нужно SMS-информирование по данному автоплатежу, то подтвердите операцию."/>
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                        <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                            com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                                    </enabled>
                                </handler>
                            </handlers>
                        </next-state>
                         <!-- переходим в статус INITIAL_LONG_OFFER подготовленный в билинге платеж для заполнения параметров шинного автоплатежа -->
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LongOfferBillingPaymentRequisitesSufficientCondition" state="INITIAL_LONG_OFFER">
                            <!--для полностью заполеннного документа выполянем действия-->
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DisallowAdditionalCardPaymentHandler"/>
                                <!--считаем комисиию-->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.BillingPaymentCommissionSaveHandler"/>
                                <!--валидируем в гейте-->
                                <handler  class="com.rssl.phizic.business.payments.forms.meta.DefaultGateValidationHandler"/>
                                <!-- Проверка непревышения введенной суммы отстатка на карте с учетом  возможности разности валют -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DocumentSumValidationHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.NotAirlineReservationDocumentFilter"/>
                                </handler>
                                <!--сохраняем назначение платежа-->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.PaymentSystemPaymentGroundSaveHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                        <parameter name="className" value="com.rssl.phizic.gate.payments.systems.AccountPaymentSystemPayment"/>
                                    </enabled>
                                </handler>

                            </handlers>
                        </next-state>


                        <!--статус "сохранен оффлайн" ставим в случае недоступности внешних систем.-->
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.OfflineBillingPaymentRequisitesSufficientCondition" state="OFFLINE_SAVED">
                            <!--для полностью заполеннного документа выполянем действия-->
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DisallowAdditionalCardPaymentHandler"/>
                                <!--проверяем ограничения на сумму платежа-->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                                <!--сохраняем назначение платежа-->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.PaymentSystemPaymentGroundSaveHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                        <parameter name="className" value="com.rssl.phizic.gate.payments.systems.AccountPaymentSystemPayment"/>
                                    </enabled>
                                </handler>
                                <!-- сброс текстовки -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            </handlers>
                        </next-state>

                        <!--статус сохранен ставим в случае остуствия незаполенных полей.-->
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.BillingPaymentRequisitesSufficientCondition" state="SAVED">
                            <!--для полностью заполеннного документа выполянем действия-->
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DisallowAdditionalCardPaymentHandler"/>
                                <!--считаем комисиию-->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.BillingPaymentCommissionSaveHandler"/>
                                <!--проверяем ограничения на сумму платежа-->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                                <!--валидируем в гейте-->
                                <handler  class="com.rssl.phizic.business.payments.forms.meta.DefaultGateValidationHandler"/>
                                <!-- Проверка непревышения введенной суммы отстатка на карте с учетом  возможности разности валют -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DocumentSumValidationHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.NotAirlineReservationDocumentFilter"/>
                                </handler>
                                <!--сохраняем назначение платежа-->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.PaymentSystemPaymentGroundSaveHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                        <parameter name="className" value="com.rssl.phizic.gate.payments.systems.AccountPaymentSystemPayment"/>
                                    </enabled>
                                </handler>

                                <!-- проверка по барсу в случае если сразу переходим на форму подтверждения(view), платеж уже готов -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.BarsReceiverNameHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.BarsReceiverNameHandlerFilter">
                                        <parameter name="className1" value="com.rssl.phizic.gate.payments.systems.AccountPaymentSystemPayment"/>
                                        <parameter name="className2" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment"/>
                                    </enabled>
                                </handler>

                            </handlers>
                        </next-state>
                    </next-states>
				</event>

                <event name="SAVE" description="Сохранение документа сотрудником"  type="employee" lock="true">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DisallowAdditionalCardPaymentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.mobilebank.CheckChargeOffCardToMobilBankHandler">
                            <parameter name="prohibition-message" value="Для выбранной карты не подключена услуга «Мобильный банк». Пожалуйста, укажите другую карту списания."/>
                            <parameter name="warning-message" value="Клиент не сможет получать SMS-сообщения об операциях по автоплатежу, потому что к карте списания не подключена услуга «Мобильный банк». Если не нужно SMS-информирование по данному автоплатежу, то подтвердите операцию."/>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.CheckEnteredCardForEmployeeLoginedByCardHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.CheckProviderServicePaymentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.ServiceProviderInfoSaveHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.AutoSubNotKeyFieldCleanHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <!--вызываем метод подготовки биллингового платежа. по его результатам в раширенных полях может появиться доп информация-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.PrepareBillingOfflineSupportedHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbBillingPaymentRequisitesSufficientHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                    </handlers>

                    <!--по умолчанию считаем, что есть что еще заполнять: переводим в состояние частично заполен(черновик)-->
                    <next-states default="DRAFT">
                         <!-- переходим в статус INITIAL_LONG_OFFER подготовленный в билинге платеж для заполнения параметров шинного автоплатежа -->
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LongOfferBillingPaymentRequisitesSufficientCondition" state="INITIAL_LONG_OFFER">
                            <!--для полностью заполеннного документа выполянем действия-->
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DisallowAdditionalCardPaymentHandler"/>
                                <!--считаем комисиию-->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.BillingPaymentCommissionSaveHandler"/>
                                <!--валидируем в гейте-->
                                <handler  class="com.rssl.phizic.business.payments.forms.meta.DefaultGateValidationHandler"/>
                                <!-- Проверка непревышения введенной суммы отстатка на карте с учетом  возможности разности валют -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DocumentSumValidationHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.NotAirlineReservationDocumentFilter"/>
                                </handler>
                            </handlers>
                        </next-state>
                    </next-states>
				</event>
                <event name="SAVEASTEMPLATE" description="Сохранить документ как шаблон" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DisallowAdditionalCardPaymentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.ServiceProviderInfoSaveHandler"/>
                    </handlers>
                    <next-states default="DRAFTTEMPLATE"/>
                </event>
				<event name="SAVEASTEMPLATE" description="Сохранить документ как шаблон" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DisallowAdditionalCardPaymentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.ServiceProviderInfoSaveHandler"/>
                    </handlers>
                    <next-states default="DRAFTTEMPLATE"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
            </events>
        </state>

        <state id="DRAFT" description="Частично заполеннный документ"
               client-form="/private/payments/payment.do"
               employee-form="/private/payments/edit.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="INITIAL" description="Редактирование документа клиентом" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareEditDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.ClearIntegrationModeDocumentHandler"/>
                    </handlers>
                    <next-states default="INITIAL"/>
                </event>
                <event name="INITIAL" description="Редактирование документа клиентом" type="employee">
                    <next-states default="INITIAL"/>
                </event>
                <event name="SAVE" description="Сохранение документа клиентом"  type="client" lock="true">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.CheckProviderServicePaymentHandler"/>
                        <!--вызываем метод подготовки биллингового платежа. по его результатам в раширенных полях может появиться доп информация-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.PrepareBillingOfflineSupportedHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbBillingPaymentRequisitesSufficientHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckBillingActivesForPaymentByTemplateHandler"/>
                    </handlers>
                    <!--по умосчанию считаем, что есть, что еще заполнять: переводим в состояние частично заполен(черновик)-->
                    <next-states default="DRAFT">
                         <sequence-next-states-ref name="draft_save"/>
                    </next-states>
                </event>
                <event name="SAVE" description="Сохранение документа клиентом"  type="employee" lock="true">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.CheckProviderServicePaymentHandler"/>
                        <!--вызываем метод подготовки биллингового платежа. по его результатам в раширенных полях может появиться доп информация-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbBillingPaymentRequisitesSufficientHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <!--по умосчанию считаем, что есть, что еще заполнять: переводим в состояние частично заполен(черновик)-->
                    <next-states default="DRAFT">
                         <sequence-next-states-ref name="draft_save"/>
                    </next-states>
                </event>
                <event name="SAVEASTEMPLATE" description="Сохранить документ как шаблон" type="client">
                    <next-states default="DRAFTTEMPLATE">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.BillingPaymentRequisitesSufficientCondition" state="SAVED_TEMPLATE">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.BarsReceiverNameHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.BarsReceiverNameHandlerFilter">
                                        <parameter name="className1" value="com.rssl.phizic.gate.payments.systems.AccountPaymentSystemPayment"/>
                                        <parameter name="className2" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment"/>
                                    </enabled>
                                </handler>
                            </handlers>
                        </next-state>
                    </next-states>
                </event>
                <event name="EDIT" description="Редактирование документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareEditDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.ClearIntegrationModeDocumentHandler"/>
                    </handlers>
                    <next-states default="INITIAL"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
            </events>
        </state>

        <state id="INITIAL_LONG_OFFER" description="Документ, ожидающий ввода параметров автоплатежа"
               client-form="/private/payments/payment.do"
               employee-form="/private/payments/edit.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                 <event name="SAVE" type="client">
                     <next-states default="SAVED">
                         <handlers>
                             <sequence-handlers-ref name="initialLongOffer_save"/>
                             <handler class="com.rssl.phizic.business.ext.sbrf.mobilebank.CheckChargeOffCardToMobilBankHandler">
                                <parameter name="warning-message" value="Вы не сможете получать SMS-сообщения об операциях по автоплатежу, потому что к карте списания не подключена услуга «Мобильный банк». Если Вам не нужно SMS-информирование по данному автоплатежу, то подтвердите операцию."/>
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                    <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                       com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                                </enabled>
                            </handler>
                         </handlers>
                     </next-states>
                 </event>

                 <event name="SAVE" type="employee">
                     <next-states default="SAVED">
                         <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                            <handler class="com.rssl.phizic.business.payments.CheckEnteredCardForEmployeeLoginedByCardHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                    <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                       com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                                </enabled>
                            </handler>
                            <sequence-handlers-ref name="initialLongOffer_save"/>
                         </handlers>
                     </next-states>
                 </event>

                 <event name="EDIT" description="Редактирование документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareEditDocumentHandler"/>
                    </handlers>
                    <next-states default="INITIAL"/>
                 </event>

                 <event name="EDIT" description="Редактирование документа" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareEditDocumentHandler"/>
                    </handlers>
                    <next-states default="INITIAL"/>
                 </event>

                 <event name="DELETE" description="Удалить документ" type="client">
                     <next-states default="DELETED"/>
                 </event>

                 <event name="DELETE" description="Удалить документ" type="system">
                     <next-states default="DELETED"/>
                 </event>
             </events>
        </state>

        <state id="WAIT_CONFIRM" description="Документ, ожидающий дополнительного подтверждения"
               client-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="DOUNKNOW" description="таймаут" type="employee">
                    <next-states default="UNKNOW">
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.MQIntegrationDocumentCondition" state="SENT"/>
                    </next-states>
                </event>
                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW">
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.MQIntegrationDocumentCondition" state="SENT"/>
                    </next-states>
                </event>
                <event name="CONFIRM" type="employee" lock="true">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <!-- платеж создан клиентом, значит выставляем интернет банк -->
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SetChannelTypeHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SetIntegrationModeDocumentHandler"/>
                    </handlers>

                    <next-states default="DISPATCHED">
                        <sequence-next-states-ref name="confirm_employee"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                    <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment;
                                                                       com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                       com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                                <parameter name="datePropertyName" value="admissionDate"/>
                                <parameter name="datePropertyType" value="java.util.Calendar"/>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                            <!-- установка сообщения о сроках исполнения платежа -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                <parameter name="key" value="operation.payment.message"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                    </handlers>
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                    </handlers>
                    <next-states default="DELETED"/>
                </event>
                <event name="REFUSE" description="Отклонить заявку" type="employee">
                    <next-states default="REFUSED"/>
                </event>
            </events>
        </state>

       <state id="SAVED" description="Вы сохранили, но еще не подтвердили документ."
               client-form="/private/payments/confirm.do"
               employee-form="/private/payments/confirm.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <handlers>
                <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.ReceiverNameByTemplateInfoHandler">
                    <enabled class="com.rssl.phizic.business.payments.forms.meta.filters.ByTemplatePaymentFilter"/>
                </handler>
            </handlers>

            <events>
                <event name="DOUNKNOW" description="таймаут" type="client">
                    <next-states default="UNKNOW">
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.MQIntegrationDocumentCondition" state="SENT"/>
                    </next-states>
                </event>

                <event name="DOUNKNOW" description="таймаут" type="employee">
                    <next-states default="UNKNOW">
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.MQIntegrationDocumentCondition" state="SENT"/>
                    </next-states>
                </event>

                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW">
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.MQIntegrationDocumentCondition" state="SENT"/>
                    </next-states>
                </event>

                <event name="DOWAITCONFIRM" description="Перевод документа в ожидание дополнительной обработки" type="client">
                    <handlers>
                        <sequence-handlers-ref name="confirm"/>
                    </handlers>
                    <next-states default="WAIT_CONFIRM">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                                <parameter name="datePropertyName" value="admissionDate"/>
                                <parameter name="datePropertyType" value="java.util.Calendar"/>
                            </handler>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.ReceiverNameByTemplateSaveHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.filters.ByTemplatePaymentFilter"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>

                <event name="CONFIRM" description="Отправка документа клиентом" type="client" lock="true">
                    <handlers>
                         <!-- событие подтверждения клиентское, поэтому сеттим интернет банк(IB) -->
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SetChannelTypeHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedBillingPaymentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckMobileServiceProviderHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ApplicationIsMobileFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckATMServiceProviderHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ApplicationIsATMFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckSocialServiceProviderHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ApplicationIsSocialFilter"/>
                        </handler>
                        <sequence-handlers-ref name="confirm"/>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.basket.subscription.SetWaitInvoiceSubscriptionStateForAPHandler">
                            <parameter name="status" value="DELETED"/>
                        </handler>

                        <handler class="com.rssl.phizic.business.ext.sbrf.mobilebank.CheckChargeOffCardToMobilBankHandler">
                            <parameter name="warning-message" value="Вы не сможете получать SMS-сообщения об операциях по автоплатежу, потому что к карте списания не подключена услуга «Мобильный банк»."/>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment;
                                                                   com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.FromPanelBlockHandler"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SetIntegrationModeDocumentHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.OfflineDelayedCondition" state="OFFLINE_DELAYED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                                    <parameter name="datePropertyName" value="admissionDate"/>
                                    <parameter name="datePropertyType" value="java.util.Calendar"/>
                                </handler>
                                <!-- сброс текстовки -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.ReceiverNameByTemplateSaveHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.filters.ByTemplatePaymentFilter"/>
                                </handler>
                            </handlers>
                        </next-state>
                        <sequence-next-states-ref name="confirm"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                                <parameter name="datePropertyName" value="admissionDate"/>
                                <parameter name="datePropertyType" value="java.util.Calendar"/>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                            <!-- установка сообщения о сроках исполнения платежа -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                <parameter name="key" value="operation.payment.message"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="CONFIRM" description="Отправка документа сотрудником" type="employee" lock="true">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SetChannelTypeHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetConfirmEmployeeIdHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <sequence-handlers-ref name="confirm"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.mobilebank.CheckChargeOffCardToMobilBankHandler">
                            <parameter name="prohibition-message" value="Для выбранной карты не подключена услуга «Мобильный банк». Пожалуйста, укажите другую карту списания."/>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.CheckEnteredCardForEmployeeLoginedByCardHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment;
                                                                   com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SetIntegrationModeDocumentHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <sequence-next-states-ref name="confirm"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                                <parameter name="datePropertyName" value="admissionDate"/>
                                <parameter name="datePropertyType" value="java.util.Calendar"/>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                            <!-- установка сообщения о сроках исполнения платежа -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                <parameter name="key" value="operation.payment.message"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="EDIT" description="Редактирование документа" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.ClearIntegrationModeDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareEditDocumentHandler">
                             <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.AccountPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.systems.AccountPaymentSystemPayment;
                                                                   com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DeniedEditPaymentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.AutoPaymentNextPayDateAction">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                               <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer"/>
                           </enabled>
                        </handler>
                    </handlers>
                    <next-states default="INITIAL">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.BarCodeJurPaymentCondition"                           state="DRAFT"/>
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LongOfferBillingPaymentRequisitesSufficientCondition" state="INITIAL_LONG_OFFER"/>
                    </next-states>
                </event>
                <event name="EDIT" description="Редактирование документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.ClearIntegrationModeDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareEditDocumentHandler">
                             <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.AccountPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.systems.AccountPaymentSystemPayment;
                                                                   com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="INITIAL">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LongOfferBillingPaymentRequisitesSufficientCondition" state="INITIAL_LONG_OFFER"/>
                    </next-states>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
            </events>
        </state>

        <state id="OFFLINE_SAVED" description="Вы сохранили, но еще не подтвердили документ."
               client-form="/private/payments/confirm.do"
               employee-form="/private/payments/confirm.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="DOUNKNOW" description="таймаут" type="client">
                    <next-states default="UNKNOW">
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.MQIntegrationDocumentCondition" state="SENT"/>
                    </next-states>
                </event>

                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW">
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.MQIntegrationDocumentCondition" state="SENT"/>
                    </next-states>
                </event>

                <event name="DOWAITCONFIRM" description="Перевод документа в ожидание дополнительной обработки" type="client">
                    <handlers>
                        <sequence-handlers-ref name="confirm"/>
                    </handlers>
                    <next-states default="WAIT_CONFIRM">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                                <parameter name="datePropertyName" value="admissionDate"/>
                                <parameter name="datePropertyType" value="java.util.Calendar"/>
                            </handler>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>

                <event name="CONFIRM" description="Отправка документа клиентом" type="client" lock="true">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedBillingPaymentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareDocumentOfflineSupportedHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.BillingPaymentRequisitesSufficientHandler"/>
                         <!-- событие подтверждения клиентское, поэтому сеттим интернет банк(IB) -->
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SetChannelTypeHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckMobileServiceProviderHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ApplicationIsMobileFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckATMServiceProviderHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ApplicationIsATMFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckSocialServiceProviderHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ApplicationIsSocialFilter"/>
                        </handler>
                        <sequence-handlers-ref name="confirm"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.mobilebank.CheckChargeOffCardToMobilBankHandler">
                            <parameter name="warning-message" value="Вы не сможете получать SMS-сообщения об операциях по автоплатежу, потому что к карте списания не подключена услуга «Мобильный банк»."/>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment;
                                                                   com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.FromPanelBlockHandler"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SetIntegrationModeDocumentHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.OfflineDelayedCondition" state="OFFLINE_DELAYED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                                    <parameter name="datePropertyName" value="admissionDate"/>
                                    <parameter name="datePropertyType" value="java.util.Calendar"/>
                                </handler>
                                <!-- сброс текстовки -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            </handlers>
                        </next-state>
                        <sequence-next-states-ref name="confirm"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                                <parameter name="datePropertyName" value="admissionDate"/>
                                <parameter name="datePropertyType" value="java.util.Calendar"/>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                            <!-- установка сообщения о сроках исполнения платежа -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                <parameter name="key" value="operation.payment.message"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>

                <event name="CONFIRM" description="Отправка документа сотрудником" type="employee" lock="true">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SetChannelTypeHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <sequence-handlers-ref name="confirm"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.mobilebank.CheckChargeOffCardToMobilBankHandler">
                            <parameter name="prohibition-message" value="Для выбранной карты не подключена услуга «Мобильный банк». Пожалуйста, укажите другую карту списания."/>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.CheckEnteredCardForEmployeeLoginedByCardHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment;
                                                                   com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbBillingPaymentRequisitesSufficientHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SetIntegrationModeDocumentHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <sequence-next-states-ref name="confirm"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                                <parameter name="datePropertyName" value="admissionDate"/>
                                <parameter name="datePropertyType" value="java.util.Calendar"/>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                            <!-- установка сообщения о сроках исполнения платежа -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                <parameter name="key" value="operation.payment.message"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>

                <event name="EDIT" description="Редактирование документа" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.ClearIntegrationModeDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareEditDocumentHandler">
                             <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.longoffer.AccountPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.systems.AccountPaymentSystemPayment;
                                                                   com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="INITIAL">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LongOfferBillingPaymentRequisitesSufficientCondition" state="INITIAL_LONG_OFFER"/>
                    </next-states>
                </event>

                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>

                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
            </events>
        </state>

        <state id="DELAYED_DISPATCH" description="Ожидается передача документа на обработку в банк."
               client-form="/private/payments/view.do"
			   employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <handlers>
                <handler class="com.rssl.phizic.business.payments.forms.meta.ClearOfflineDelayedRowHandler"/>
            </handlers>
            <events>
                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW">
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.MQIntegrationDocumentCondition" state="SENT"/>
                    </next-states>
                </event>
                <event name="DISPATCH" description="Отправка документа клиентом"
					   type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedBillingPaymentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckOfflineDelayedHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckCommissionSumAction"/>

						<handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.CheckProviderServicePaymentHandler"/>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment;
                                                                   com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                   com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                            </enabled>
                        </handler>
						<handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
					</handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.ESBBillingPaymentCondition" state="EXECUTED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                                <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                        <parameter name="whiteList" value="sms"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                        <parameter name="whiteList" value="CreditReportPayment"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                    <parameter name="state" value="EXECUTED"/>
                                </handler>
                             </handlers>
                        </next-state>
                        <handlers>
                            <!-- установка сообщения о сроках исполнения платежа -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                <parameter name="key" value="operation.payment.message"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.externalPayments.UpdateUECOrderState"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                        </handler>
                    </handlers>
                    <next-states default="ERROR"/>
                </event>
                <event name="EXECUTE" description="Подтверждение документа системой" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.externalPayments.UpdateUECOrderState"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="CreditReportPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.externalPayments.UpdateUECOrderState"/>
                        </handlers>
                    </next-states>
                </event>
            </events>
		</state>

        <state id="OFFLINE_DELAYED" description="Ожидается передача документа на обработку в банк."
               client-form="/private/payments/view.do"
			   employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.forms.meta.ClearOfflineDelayedRowHandler"/>
            </handlers>
            <events>
                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW">
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.MQIntegrationDocumentCondition" state="SENT"/>
                    </next-states>
                </event>
                <event name="DISPATCH" description="Отправка документа клиентом"
					   type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedBillingPaymentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SetIntegrationModeDocumentHandler"/>
					</handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.OfflineDelayedCondition" state="OFFLINE_DELAYED">
                            <handlers>
                                <!-- сброс текстовки -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            </handlers>
                        </next-state>
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.MQIntegrationDocumentCondition" state="EXECUTED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareDocumentHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.BillingPaymentRequisitesSufficientHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckCommissionSumAction"/>
                                <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.CheckProviderServicePaymentHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                        <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment;
                                                                           com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                           com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                                <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                        <parameter name="whiteList" value="sms"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>

                                <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                        <parameter name="whiteList" value="CreditReportPayment"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                    <parameter name="state" value="EXECUTED"/>
                                </handler>
                            </handlers>
                        </next-state>
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.IQWaveBillingPaymentCondition" state="DISPATCHED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareDocumentHandler"/>

                                <handler class="com.rssl.phizic.business.payments.forms.meta.BillingPaymentRequisitesSufficientHandler"/>

                                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckCommissionSumAction"/>

                                <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.CheckProviderServicePaymentHandler"/>

                                <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                        <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment;
                                                                           com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                           com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.ermb.handlers.ErmbBillingPaymentRequisitesSufficientHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                        <parameter name="whiteList" value="sms"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                                <!-- установка сообщения о сроках исполнения платежа -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                    <parameter name="key" value="operation.payment.message"/>
                                </handler>
                            </handlers>
                        </next-state>
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.DelayedStateCondition" state="DELAYED_DISPATCH">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SumRestrictionHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                                    <parameter name="datePropertyName" value="admissionDate"/>
                                    <parameter name="datePropertyType" value="java.util.Calendar"/>
                                </handler>
                                <!-- сброс текстовки -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            </handlers>
                        </next-state>
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.ESBBillingPaymentCondition" state="EXECUTED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareDocumentHandler"/>

                                <handler class="com.rssl.phizic.business.payments.forms.meta.BillingPaymentRequisitesSufficientHandler"/>

                                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckCommissionSumAction"/>

                                <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.CheckProviderServicePaymentHandler"/>

                                <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                        <parameter name="className" value="com.rssl.phizic.gate.payments.systems.CardPaymentSystemPayment;
                                                                           com.rssl.phizic.gate.payments.longoffer.CardPaymentSystemPaymentLongOffer;
                                                                           com.rssl.phizic.gate.payments.longoffer.EmployeeCardPaymentSystemPaymentLongOffer"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>

                                <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                                <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                        <parameter name="whiteList" value="sms"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>

                                <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                        <parameter name="whiteList" value="CreditReportPayment"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                    <parameter name="state" value="EXECUTED"/>
                                </handler>
                            </handlers>
                        </next-state>
                        <handlers>
                            <!-- установка сообщения о сроках исполнения платежа -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                <parameter name="key" value="operation.payment.message"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.messaging.payments.handlers.SmsOfRefuseOperationHandler">
                             <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="blackList" value="sms"/>
                             </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                             <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                 <parameter name="whiteList" value="sms"/>
                             </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.externalPayments.UpdateUECOrderState"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.messaging.payments.handlers.SmsOfRefuseOperationHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="blackList" value="sms"/>
                             </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="ERROR"/>
                </event>
                <event name="EXECUTE" description="Подтверждение документа системой" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.externalPayments.UpdateUECOrderState"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="CreditReportPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.messaging.payments.handlers.SmsOfRefuseOperationHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="blackList" value="sms"/>
                             </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.externalPayments.UpdateUECOrderState"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="RECALL" description="Отзыв документа" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                    </handlers>
                    <next-states default="RECALLED"/>
                </event>
            </events>
        </state>

        <state id="DISPATCHED" description="Документ подтвержден и передан на обработку в банк."
               client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ABSSystemNameResolver">

            <events>
                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW"/>
                </event>

                <event name="REPEAT_SEND" description="Подтверждение документа системой" type="system">
                    <next-states default="DISPATCHED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.BusinessDocumentRepeatSendHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="EXECUTE" description="Подтверждение документа системой" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.externalPayments.UpdateUECOrderState"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="CreditReportPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="EXECUTE" description="Подтверждение документа системой" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.externalPayments.UpdateUECOrderState"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="CreditReportPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="PARTLY_EXECUTED" description="Подтверждение документа АБС в ходе двухфазной транзакции  " type="system">
                    <next-states default="PARTLY_EXECUTED"/>
                </event>

                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                        <!-- откатываем лимит -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TestClientBlockedHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>

                <event name="ERROR" description="При работе с документом произошла ошибка" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                        </handler>
                        <!-- откатываем лимит -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.basket.subscription.RestoreWaitInvoiceSubscriptionStateForAPHandler"/>
                    </handlers>
                    <next-states default="ERROR"/>
                </event>
            </events>
        </state>

        <state id="PARTLY_EXECUTED" description="Документ подтвержден и передан на обработку в банк."
               client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="BILLING_CONFIRM_TIMEOUT" description="Таймаут при подтверждении в биллинге (ЕРИБ)" type="system">
                    <next-states default="BILLING_CONFIRM_TIMEOUT"/>
                </event>

                <event name="BILLING_GATE_CONFIRM_TIMEOUT" description="Таймаут при подтверждении в биллинге (шлюз)" type="system">
                    <next-states default="BILLING_GATE_CONFIRM_TIMEOUT"/>
                </event>

                <event name="ABS_RECALL_TIMEOUT" description="Таймаут при отзыве платежа в АБС (ЕРИБ)" type="system">
                    <next-states default="ABS_RECALL_TIMEOUT"/>
                </event>

                <event name="ABS_GATE_RECALL_TIMEOUT" description="Таймаут при отзыве платежа в АБС (шлюз)" type="system">
                    <next-states default="ABS_GATE_RECALL_TIMEOUT"/>
                </event>

                <event name="EXECUTE" description="Подтверждение документа системой" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="CreditReportPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                    </handlers>
                    <next-states default="ERROR"/>
                </event>
            </events>
        </state>

        <state id="EXECUTED" description="Платеж успешно исполнен банком: денежные средства переведены на счет получателя платежа."
               client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
        </state>

        <state id="REFUSED" description="Вам отказано в исполнении операции по какой-либо причине."
               client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
       </state>

        <state id="ERROR" description="Документ не может быть исполнен, Вам необходимо обратиться в банк."
               client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.forms.meta.externalPayments.UpdateUECOrderState"/>
            </handlers>
            <events>
                <event name="EXECUTE" description="Подтверждение документа системой" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="CreditReportPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
		    </events>
        </state>

        <state id="UNKNOW" description="Документ подтвержден и передан на обработку в банк."
			   client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="SPECIFY" description="Уточнение состояния документа" type="employee" lock="true">
                    <next-states default="UNKNOW">
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.AutoSubscriptionCondition" state="DISPATCHED" description="Заявка на создание автоплатежа подтверждена и передана на обработку в банк.">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.ValidateAutoPaymentStartDateHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                                <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                        <parameter name="whiteList" value="sms"/>
                                    </enabled>
                                </handler>
                                <!-- сброс текстовки -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                             </handlers>
                            <!--фильтруем документы, отправленные в подразделение, обслуживаемое шиной-->
                            <enabled class="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.DocumentOfficeESBSupportedFilter"/>
                        </next-state>
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.ESBBillingPaymentCondition" state="EXECUTED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.BusinessDocumentRepeatSendHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                                <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                        <parameter name="whiteList" value="sms"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                                <!-- сброс текстовки -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                        <parameter name="whiteList" value="CreditReportPayment"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                    <parameter name="state" value="EXECUTED"/>
                                </handler>
                             </handlers>
                            <!--фильтруем документы, отправленные в подразделение, обслуживаемое шиной-->
                            <enabled class="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.DocumentOfficeESBSupportedFilter"/>
                        </next-state>
                    </next-states>
                </event>
                <event name="SPECIFY" description="Автоматическое уточнение состояния документа" type="system" lock="true">
                    <next-states default="UNKNOW">
                        <!-- автодокат шинных билинговых платежей. -->
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.ESBBillingPaymentCondition" state="EXECUTED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.BusinessDocumentRepeatSendHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                                <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                        <parameter name="whiteList" value="sms"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                                <!-- сброс текстовки -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                        <parameter name="whiteList" value="CreditReportPayment"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                    <parameter name="state" value="EXECUTED"/>
                                </handler>
                             </handlers>
                            <!--фильтруем документы, отправленные в подразделение, обслуживаемое шиной-->
                            <enabled class="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.DocumentOfficeESBSupportedFilter"/>
                        </next-state>
                    </next-states>
                </event>
                <event name="REPEAT_SEND" description="Повторная отправка документа системой" type="system">
                    <next-states default="DISPATCHED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.BusinessDocumentRepeatSendHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                <parameter name="key" value="operation.transfer.message"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="EXECUTE" description="Подтверждение документа сотрудником" type="employee">
                     <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                         <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                             <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                 <parameter name="whiteList" value="sms"/>
                             </enabled>
                         </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="CreditReportPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                    </handlers>
                    <next-states default="ERROR"/>
                </event>
                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW"/>
                </event>
            </events>
		</state>

        <state id="SENT" description="Документ подтвержден и передан на обработку в банк."
			   client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="EXECUTE" description="Подтверждение документа сотрудником" type="employee">
                     <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                         <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                             <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                 <parameter name="whiteList" value="sms"/>
                             </enabled>
                         </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="CreditReportPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="EXECUTE" description="Подтверждение документа системой" type="system">
                     <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                         <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                             <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                 <parameter name="whiteList" value="sms"/>
                             </enabled>
                         </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа системой" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
            </events>
		</state>

        <state id="BILLING_CONFIRM_TIMEOUT" description="Статус документа не определен. Пожалуйста, обратитесь в Контактный центр банка для уточнения информации."
			   client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="EXECUTE" description="Подтверждение документа сотрудником" type="employee">
                     <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                         <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                             <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                 <parameter name="whiteList" value="sms"/>
                             </enabled>
                         </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="CreditReportPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                         <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                    </handlers>
                    <next-states default="ERROR"/>
                </event>
            </events>
		</state>

        <state id="BILLING_GATE_CONFIRM_TIMEOUT" description="Статус документа не определен. Пожалуйста, обратитесь в Контактный центр банка для уточнения информации."
			   client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="EXECUTE" description="Подтверждение документа сотрудником" type="employee">
                     <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                         <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                             <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                 <parameter name="whiteList" value="sms"/>
                             </enabled>
                         </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExecutedDocumentSendToIPSHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreditReportPaymentExecuteHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="CreditReportPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                        </handler>
                    </handlers>
                    <next-states default="ERROR"/>
                </event>
            </events>
		</state>

        <state id="ABS_RECALL_TIMEOUT" description="Статус документа не определен. Произошла ошибка при отзыве документа. Пожалуйста, обратитесь в Контактный центр банка для уточнения информации."
			   client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                        </handler>
                    </handlers>
                    <next-states default="ERROR"/>
                </event>
            </events>
		</state>

        <state id="ABS_GATE_RECALL_TIMEOUT" description="Статус документа не определен. Произошла ошибка при отзыве документа. Пожалуйста, обратитесь в Контактный центр банка для уточнения информации."
			   client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                    </handlers>
                    <next-states default="ERROR"/>
                </event>
            </events>
		</state>

        <state id="RECALLED" description="Документ отозван Вами по какой-либо причине."
			client-form="/private/payments/view.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state id="DELETED" description="Документ удален."
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
        </state>
    </states>

	<states name="PaymentStateMachine" inital-state="INITIAL" saveNodeInfo="true"
	        description="МС документа, не требующего подтверждения сотрудником банка и направленного прямо в ритейл">

        <sequences-handlers>
            <sequence name="confirm">
                <!--CHG062132: Сообщение о невозможности изменить процентную ставку у закрытого вклада-->
                <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeDepositMinimumBalanceStatusHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="ChangeDepositMinimumBalanceClaim"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.documents.payments.handlers.OutsidePaymentFromTemplateHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="JurPayment;RurPayment"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.DisallowExternalAccountPaymentHandler"/>

                <!-- BUG039919: Сообщение клиенту при оплате со вклада через шаблон 40 ТБ -->
                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="JurPayment"/>
                    </enabled>
                </handler>
                 <!-- CHG030960: запретить клиентам оплачивать кредит во внеоперационное время  -->
                <handler class="com.rssl.phizic.business.payments.ValidateLoanReceptionTimeHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="LoanPayment"/>
                    </enabled>
                </handler>
                <!-- Проверка непревышения введенной суммы отстатка на карте с учетом  возможности разности валют -->
                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAmountCurrencyValidator">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="ExternalProviderPayment;FNSPayment;AirlineReservationPayment"/>
                    </enabled>
                </handler>

                <!-- Проверка кредита на незакрытость и отображаемость в системе -->
                <handler class="com.rssl.phizic.business.payments.ValidateLoanVisibilityHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="LoanPayment"/>
                    </enabled>
                </handler>

                <handler class="com.rssl.phizic.business.payments.forms.meta.ReceptionTimeDelayedStateHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="AccountOpeningClaimWithClose"/>
                    </enabled>
                </handler>

                <handler class="com.rssl.phizic.business.payments.ValidatePaymentAccountHandler">
                    <parameter name="checkType" value="payer"/>
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="RurPayment;JurPayment;LoanPayment;AccountOpeningClaim"/>
                    </enabled>
                </handler>

                <handler class="com.rssl.phizic.business.payments.ValidatePaymentAccountOpeningHandler">
                    <parameter name="checkType" value="payer"/>
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="AccountOpeningClaimWithClose"/>
                    </enabled>
                </handler>

                <handler class="com.rssl.phizic.business.payments.ValidatePaymentAccountHandler">
                    <parameter name="checkType" value="both"/>
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="PurchaseCurrencyPayment;SaleCurrencyPayment;ConvertCurrencyPayment;InternalPayment;IMAPayment;IMAOpeningClaim"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.ValidatePaymentAmountAction">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="RurPayment;JurPayment;LoanPayment;InternalPayment;IMAPayment;IMAOpeningClaim"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                    <parameter name="datePropertyName" value="admissionDate"/>
                    <parameter name="datePropertyType" value="java.util.Calendar"/>
                    <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocTypeAndFormNameFilter">
                        <parameter name="whiteList" value="RurPayment;PurchaseCurrencyPayment;SaleCurrencyPayment;ConvertCurrencyPayment;InternalPayment;LossPassbookApplication;JurPayment;LoanPayment;RefuseLongOffer;EditAutoPayment;AccountOpeningClaim;IMAPayment;IMAOpeningClaim;AccountOpeningClaimWithClose;AccountChangeInterestDestinationClaim;ChangeDepositMinimumBalanceClaim"/>
                        <parameter name="deniedTypes" value="com.rssl.phizic.gate.payments.InternalCardsTransfer;
                                                             com.rssl.phizic.gate.payments.ExternalCardsTransferToOurBank;
                                                             com.rssl.phizic.gate.payments.ExternalCardsTransferToOtherBank"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.SimpleBusinessDocumentDateAction">
                    <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                        <parameter name="className" value="com.rssl.phizic.gate.payments.InternalCardsTransfer;
                                                           com.rssl.phizic.gate.payments.ExternalCardsTransferToOurBank;
                                                           com.rssl.phizic.gate.payments.ExternalCardsTransferToOtherBank"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckImmediatePaymentDateHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="InternalPayment;ConvertCurrencyPayment;RurPayment;LoanPayment;EditAutoPayment"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckLongOfferStartDateHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="InternalPayment;ConvertCurrencyPayment;RurPayment;LoanPayment;EditAutoPayment"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.CheckRateDidntChangeHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="InternalPayment;ConvertCurrencyPayment;AccountOpeningClaim;IMAPayment;IMAOpeningClaim"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckDebtsSplittingHandler">
                    <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                        <parameter name="className" value="com.rssl.phizic.gate.payments.LoanTransfer"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.DocumentSumValidationHandler">
                    <parameter name="useInTemplate" value="false"/>
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="RurPayment;InternalPayment;ConvertCurrencyPayment;JurPayment;AccountOpeningClaim;IMAPayment;IMAOpeningClaim"/>
                    </enabled>
                </handler>

                <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningSumHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="AccountOpeningClaim"/>
                    </enabled>
                </handler>

                <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningTypeHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                    </enabled>
                </handler>

                <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningClaimPrepareHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="AccountOpeningClaimWithClose"/>
                    </enabled>
                </handler>
	            <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningDateReplaceHandler">
		            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
			            <parameter name="whiteList" value="AccountOpeningClaim"/>
		            </enabled>
	            </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningDateHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="AccountOpeningClaim"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.IMAOpeningClaimChangeOpeningDateHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="IMAOpeningClaim"/>
                    </enabled>
                </handler>

                <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningClaimCheckPensionHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                    </enabled>
                </handler>

                <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningPercentHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="AccountOpeningClaim"/>
                    </enabled>
                </handler>

                <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningChangeTermsHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                    </enabled>
                </handler>
                <handler  class="com.rssl.phizic.business.payments.forms.meta.IMAPaymentHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="IMAPayment;"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.ValidateAutoPaymentStartDateHandler"/>

                <handler class="com.rssl.phizic.business.payments.forms.meta.AccountChangeInterestDestinationHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="AccountChangeInterestDestinationClaim"/>
                    </enabled>
                </handler>

                <handler class="com.rssl.phizic.business.payments.forms.meta.BlockingCardClaimHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="BlockingCardClaim"/>
                    </enabled>
                </handler>

                <handler class="com.rssl.phizic.business.payments.CalcAndCheckCommisionChangedHandler">
                    <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                        <parameter name="className" value="com.rssl.phizic.gate.payments.CardIntraBankPayment;
                                                           com.rssl.phizic.gate.payments.CardRUSPayment"/>
                    </enabled>
                </handler>

                 <!--хэндлер для  очищения поля infoAvailableCardWasShow-->
                <handler class="com.rssl.phizic.business.payments.forms.meta.InfoAvailableCardClearHandler">
                    <parameter name="whiteList" value="RurPayment"/>
                </handler>

                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckCommissionSumAction">
                    <enabled class="com.rssl.phizic.business.payments.forms.meta.ExternalProviderESBPaymentFilter"/>
                </handler>

                <!--<handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="blackList" value="ConvertCurrencyLongOfferPayment"/>
                    </enabled>
                </handler> -->  <!--
                <handler class="com.rssl.phizic.operations.ext.sbrf.payment.ConvertCurrencyLongOfferPaymentSender">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="ConvertCurrencyLongOfferPayment"/>
                    </enabled>
                </handler>      -->
            </sequence>
            <sequence name="executed_handlers">
                <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                    <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                        <parameter name="whiteList" value="sms"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                <!-- сброс текстовки -->
                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
            </sequence>
        </sequences-handlers>

        <sequences-next-states>
            <sequence name="confirm">
                <!-- Отлавливаем измененные поля, остаемся в том же состоянии при их наличии -->
                <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.FieldsAreChangedStateObjectCondition" state="SAVED"/>
               <!--карточный перевод - онлайн операция-->
                <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.CardsTransferCondition" state="EXECUTED">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                        <handler class="com.rssl.phizic.messaging.payments.handlers.MessageToReceiverHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="RurPayment"/>
                            </enabled>
                        </handler>
                        <!-- установка сообщения о сроках исполнения платежа -->
                        <!-- в Сбербанке -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                            <parameter name="key" value="operation.completed.message"/>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.ExternalCardsTransferToOurBank;
                                                                   com.rssl.phizic.gate.payments.InternalCardsTransfer;
                                                                   com.rssl.phizic.gate.payments.CardToIMATransfer;
                                                                   com.rssl.phizic.gate.payments.IMAToCardTransfer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.AddOrUpdateReminderStateHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                            <parameter name="key" value="operation.tomorrow.message"/>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.ExternalCardsTransferToOtherBank"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SavePaymentInvoiceMessageHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                            <parameter name="state" value="EXECUTED"/>
                        </handler>
                     </handlers>
                </next-state>
                <!--блокировка карты - онлайн операция-->
                <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.BlockingCardClaimCondition" state="EXECUTED">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                     </handlers>
                </next-state>

                <!--перевыпуск карты - онлайн операция-->
                <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.ReIssueCardClaimCondition" state="EXECUTED">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                     </handlers>
                </next-state>

                <!--сообщения IQW не должны учитывать время приема документов-->
                <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.IQWaveBillingPaymentCondition" state="DISPATCHED">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <!-- установка сообщения о сроках исполнения платежа -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                            <parameter name="key" value="operation.transfer.message"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SavePaymentInvoiceMessageHandler"/>
                     </handlers>
                </next-state>

                <!-- Длительные поручения нельзя подтвержадать в внеоперационное время. -->
                <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LongOfferRefusedStateCondition" state="REFUSED" description="Плановая дата исполнения не может быть больше даты начала действия">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                    </handlers>
                </next-state>
                <!--Остальные документы отсылаются только в операционное время-->
                <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.DelayedStateCondition" state="DELAYED_DISPATCH">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.AddOrUpdateReminderStateHandler"/>
                        <!-- сброс текстовки -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SavePaymentInvoiceMessageHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                                <parameter name="datePropertyName" value="admissionDate"/>
                                <parameter name="datePropertyType" value="java.util.Calendar"/>
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                                </enabled>
                            </handler>
                    </handlers>
                </next-state>

                <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.AirlineReservationPaymentCondition" state="TICKETS_WAITING">
                    <handlers>
                        <!-- установка сообщения о сроках исполнения платежа -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                            <parameter name="key" value="dispatched.to.executed.message"/>
                        </handler>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="EXECUTED"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AirlineReservationPayment"/>
                            </enabled>
                        </handler>
                    </handlers>
                </next-state>

                <!--сообщения через шину - онлайн-->
                <!--Для отправки заявки об утере сберкнижки делается дополнительная проверка на доступность функционала на КСШ для данного ТБ-->
                <!--todo заменить на ESBERIBPaymentsCondition после того как во всех ТБ на КСШ будет реализован фукционал подачи заявки об утере сберкнижки (CHG039252)-->
                <!--<next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.ESBERIBPaymentsCondition" state="EXECUTED">-->
                <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.ESBERIBLossPassbookApplicationCondition" state="EXECUTED">
                    <handlers>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningMainDocumentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="blackList" value="AccountChangeInterestDestinationClaim;ChangeDepositMinimumBalanceClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.UpdateLongOfferLinksHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.LongOfferClaimFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.UpdateAccountLinksHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountChangeInterestDestinationClaim;ChangeDepositMinimumBalanceClaim;AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.UpdateAccountTargetHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningClaimFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ima.UpdateIMAccountLinksHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ima.IMAOpeningClaimFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.AddOrUpdateReminderStateHandler"/>
                        <!-- установка сообщения о сроках исполнения платежа -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                            <parameter name="key" value="operation.completed.message"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.SavePaymentInvoiceMessageHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                            <parameter name="state" value="EXECUTED"/>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="EXECUTED"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>

                     </handlers>
                </next-state>
            </sequence>
            <sequence name="tickets_waiting">
                <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.AirlineReservationPaymentCondition" state="TICKETS_WAITING">
                    <handlers>
                        <!-- установка сообщения о сроках исполнения платежа -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                            <parameter name="key" value="dispatched.to.executed.message"/>
                        </handler>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="EXECUTED"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AirlineReservationPayment"/>
                            </enabled>
                        </handler>
                    </handlers>
                </next-state>
            </sequence>
        </sequences-next-states>

		<state id="INITIAL" description="Вы создали, но еще не сохранили документ"
			client-form="/private/payments/payment.do"
            system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <handlers>
                <!-- Заполнение значения кода группы вкладного продукта -->
                <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningDepositGroupHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="AccountOpeningClaim"/>
                    </enabled>
                </handler>
                <!-- Выполняем первичную инициализацию заявки на открытие вклада -->
                <handler class="com.rssl.phizic.business.payments.forms.meta.InitializeAccountOpeningClaimHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                    </enabled>
                </handler>
                <!-- Выполняем проверку, что по выбранной карте доступен перевыпуск -->
                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAvailabilityOfReissuingCardHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="ReIssueCardClaim"/>
                    </enabled>
                </handler>
                <!-- Проверяем доступность ЦОД для операций, отправляемых в него -->
                <handler class="com.rssl.phizic.business.payments.forms.meta.CODOperationsHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="IMAOpeningClaim"/>
                    </enabled>
                </handler>
                <!-- Проверяем активность промо-кода -->
                <handler class="com.rssl.phizic.business.payments.ValidatePromoCodeHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                    </enabled>
                </handler>
                <!-- Смена статуса интернет-заказа в EInvoicing -->
                <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                    <parameter name="state" value="PAYMENT"/>
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                    </enabled>
                </handler>
                <!--Проверяем принадлежность счёта клиенту при изменении порядка уплаты процентов-->
                <handler class="com.rssl.phizic.business.payments.forms.meta.AccountChangeInterestDestinationClaimInitHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="AccountChangeInterestDestinationClaim"/>
                    </enabled>
                </handler>
            </handlers>
			<events>
                <event name="INITIAL" description="Редактирование документа клиентом" type="client">
                    <next-states default="INITIAL"/>
                </event>
				<event name="SAVE" description="Сохранение документа клиентом"  type="client">
					<handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningMainDocumentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                           <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                               <parameter name="whiteList" value="ExternalProviderPayment;FNSPayment;AirlineReservationPayment"/>
                           </enabled>
                        </handler>

                        <!-- BUG039919: Сообщение клиенту при оплате со вклада через шаблон 40 ТБ -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoginCardHashHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.IsESBSupportedHandler">
                            <parameter name="needSpecialKeyForTextError" value="com.rssl.phizic.gate.payments.CardRUSPayment;com.rssl.phizic.gate.payments.CardJurTransfer;com.rssl.phizic.gate.payments.CardJurIntraBankTransfer;com.rssl.phizic.gate.payments.CardIntraBankPayment"/>
                            <enabled class="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.PersonCreationTypeCompositeHandlerFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.CardRUSPayment;com.rssl.phizic.gate.payments.CardJurTransfer;com.rssl.phizic.gate.payments.CardJurIntraBankTransfer;com.rssl.phizic.gate.payments.CardIntraBankPayment;
                                com.rssl.phizic.gate.claims.AccountOpeningFromCardClaim;com.rssl.phizic.gate.claims.AccountOpeningClaim;com.rssl.phizic.gate.payments.LoanTransfer;com.rssl.phizic.gate.payments.IMAToAccountTransfer;com.rssl.phizic.gate.payments.AccountToIMATransfer;
                                com.rssl.phizic.gate.payments.IMAToCardTransfer;com.rssl.phizic.gate.payments.CardToIMATransfer;
                                com.rssl.phizic.gate.claims.DemandAccountOpeningClaim"/>
                            </enabled>
                        </handler>
                        <!-- Сюда намеренно не добавлены операции Погашение кредита с карты и аналогичный регулярный платеж, т.к. кредит вообще может быть только у УДБО клиента. -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OwnerCreationTypeHandler">
                            <parameter name="creationType" value="UDBO"/>
                            <parameter name="needSpecialKeyForTextError" value="com.rssl.phizic.gate.claims.AccountOpeningFromCardClaim;
                                                                                com.rssl.phizic.gate.claims.AccountOpeningClaim;
                                                                                com.rssl.phizic.gate.claims.IMAOpeningClaim;
                                                                                com.rssl.phizic.gate.claims.DemandAccountOpeningClaim"/>
                            <enabled class="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.PersonCreationTypeCompositeHandlerFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.claims.AccountOpeningFromCardClaim;
                                                                   com.rssl.phizic.gate.claims.AccountOpeningClaim;
                                                                   com.rssl.phizic.gate.claims.IMAOpeningClaim;
                                                                   com.rssl.phizic.gate.claims.DemandAccountOpeningClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.AccountToCardConvertionSRBDenyHandler">
                            <parameter name="error-message" value="Вы не можете перевести валюту со счета на карту. Пожалуйста, выберите счет для зачисления"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CardReplenishmentValidationHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="CardReplenishmentPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.ValidateWayCardHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="blackList" value="ExternalProviderPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.TaxPaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedRurPaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="RurPayment;JurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DenyOfflineInternalTransferWithUavailableCODHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="InternalPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedInternalTransferHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="InternalPayment;IMAPayment;ConvertCurrencyPayment"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedBillingPaymentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ExternalProviderESBPaymentFilter"/>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineResourceHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="IMAOpeningClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultCommissionSaveHandler">
							<parameter name="useInTemplate" value="false"/>
							<enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="RurPayment;InternalPayment;ConvertCurrencyPayment"/>
							</enabled>
						</handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultCommissionSaveHandler">
							<parameter name="useInTemplate" value="false"/>
							<enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment"/>
							</enabled>
						</handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DocumentSumValidationHandler">
							<parameter name="useInTemplate" value="false"/>
							<enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="RurPayment;InternalPayment;ConvertCurrencyPayment;JurPayment;AccountOpeningClaim;IMAPayment;IMAOpeningClaim;"/>
							</enabled>
						</handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningTypeHandler">
							<enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
							</enabled>
						</handler>
                        <!--
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PaymentValidatorHandler">
							<parameter name="useInTemplate" value="false"/>
							<enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
								<parameter name="whiteList" value="ConvertCurrencyPayment;InternalPayment"/>
							</enabled>
						</handler>
						-->

                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetConversionOperationHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ConversionOperationFilter"/>
                        </handler>

                        <handler  class="com.rssl.phizic.business.payments.forms.meta.DefaultGateValidationHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="RurPayment;ConvertCurrencyPayment;JurPayment"/>
                            </enabled>
                        </handler>
                        <handler  class="com.rssl.phizic.business.payments.forms.meta.DefaultGateValidationHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ExternalProviderESBPaymentFilter"/>
                        </handler>

                        <handler  class="com.rssl.phizic.business.payments.forms.meta.InternalTransferGateValidationHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="InternalPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.BarsReceiverNameHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.BarsReceiverNameHandlerFilter">
                                <parameter name="className1" value="com.rssl.phizic.gate.payments.AccountJurTransfer"/>
                                <parameter name="className2" value="com.rssl.phizic.gate.payments.CardJurTransfer"/>
                                <parameter name="className3" value="com.rssl.phizic.gate.payments.longoffer.CardJurTransferLongOffer"/>
                                <parameter name="className4" value="com.rssl.phizic.gate.payments.CardJurIntraBankTransfer"/>
                                <parameter name="className5" value="com.rssl.phizic.gate.payments.longoffer.CardJurIntraBankTransferLongOffer"/>
                            </enabled>
                        </handler>
                        <handler  class="com.rssl.phizic.business.payments.forms.meta.LoanPaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="LoanPayment"/>
                            </enabled>
                        </handler>
                        <handler  class="com.rssl.phizic.business.payments.forms.meta.IMAPaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="IMAPayment;IMAOpeningClaim"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.HighlightChangedRateHandler">
                            <parameter name="highlightedField" value="courseRow"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaimWithClose"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.DenyOfflineStateByCommissionSettingHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaimWithClose"/>
                            </enabled>
                        </handler>
                        <!-- Отсылка запроса на закрытие вклада, расчет процентной ставки для вкладов без неснжаемого остатка -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningClaimPrepareHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
								<parameter name="whiteList" value="AccountOpeningClaimWithClose"/>
                            </enabled>
                        </handler>
                        <!-- Заполнение значения кода группы вкладного продукта-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningDepositGroupHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim"/>
                            </enabled>
                        </handler>
                        <!-- Заполнение полей условий договора и клиентского менеджера/промоутера при открытии вклада и доп соглашения к договору о вкладе -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeniningInitTermsHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose;AccountChangeInterestDestinationClaim"/>
                            </enabled>
                        </handler>

                        <!--проверка максимальной суммы вклада-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountCheckMaxBalanceAmountHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.AccountCheckMaxBalanceAmountFilter"/>
                        </handler>

                        <!--если перевод на карту по номеру телефона, решаем заполнять ли инфу по получате CHG041044 -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.UpdateReceiverInfoByPhoneHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocTypeAndFormNameFilter">
                                <parameter name="whiteList" value="RurPayment"/>
                                <parameter name="allowedTypes" value="com.rssl.phizic.gate.payments.ExternalCardsTransferToOurBank"/>
                            </enabled>
                        </handler>

                        <!--после заполнения инфы о получателе проверяем, совпадает ли ФИО клиента из справочника доверенных получателей с ФИО, которое пришло из  МБ (при оплате по номеру телефона)-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckReceiverClientName">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocTypeAndFormNameFilter">
                                <parameter name="whiteList" value="RurPayment"/>
                                <parameter name="allowedTypes" value="com.rssl.phizic.gate.payments.ExternalCardsTransferToOurBank"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ConversionFromCardToAccountHandler">
							<parameter name="useInTemplate" value="false"/>
							<enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="InternalPayment;ConvertCurrencyPayment"/>
							</enabled>
						</handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ConversionAccountOpeningFromCardHandler">
							<parameter name="useInTemplate" value="false"/>
							<enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim"/>
							</enabled>
						</handler>
                        <handler  class="com.rssl.phizic.business.payments.forms.meta.TariffPlanUsagePaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="IMAOpeningClaim;AccountOpeningClaim;IMAPayment;InternalPayment;"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.EInvoicingProviderInfoSaveHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ExternalProviderESBPaymentFilter"/>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.ServiceProviderInfoSaveHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ExternalProviderESBPaymentFilter"/>
                        </handler>
                        <!--вызываем метод подготовки биллингового платежа. по его результатам в раширенных полях может появиться доп информация-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareDocumentOfflineSupportedHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ExternalProviderESBPaymentFilter"/>
                        </handler>

					</handlers>
                    <next-states default="SAVED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.InfoAvailableCardCondition" state="INITIAL">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.InfoAvailableCardHandler"/>
                            </handlers>
                        </next-state>
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.FieldsAreChangedStateObjectCondition" state="INITIAL">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                            </enabled>
                        </next-state>
                    </next-states>
				</event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="REFUSED"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
			</events>
		</state>

        <state id="WAIT_CONFIRM" description="Документ, ожидающий дополнительного подтверждения"  client-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="DOUNKNOW" description="таймаут" type="employee">
                    <next-states default="UNKNOW"/>
                </event>
                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW"/>
                </event>
                <event name="CONFIRM" type="employee" lock="true">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                           <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                               <parameter name="whiteList" value="ExternalProviderPayment;FNSPayment;AirlineReservationPayment"/>
                           </enabled>
                        </handler>
                        <!-- BUG039919: Сообщение клиенту при оплате со вклада через шаблон 40 ТБ -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.CalcAndCheckCommisionChangedHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.CardIntraBankPayment;
                                                                   com.rssl.phizic.gate.payments.CardRUSPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedInternalTransferHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="InternalPayment;IMAPayment;ConvertCurrencyPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedRurPaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="RurPayment;JurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DenyOfflineStateByCommissionSettingHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                               <parameter name="whiteList" value="InternalPayment; ConvertCurrencyPayment; IMAPayment; RurPayment; IMAOpeningClaim; AccountOpeningClaim; AccountOpeningClaimWithClose"/>
                           </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedExternalProviderPaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="WRITE_OFF"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <sequence-next-states-ref name="confirm"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningMainDocumentHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.AccountPaymentPrepareHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                    <parameter name="className" value="com.rssl.phizic.gate.payments.AccountToCardTransfer;
                                                                       com.rssl.phizic.gate.payments.ClientAccountsTransfer;
                                                                       com.rssl.phizic.gate.payments.AccountIntraBankPayment;
                                                                       com.rssl.phizic.gate.payments.AccountRUSPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="blackList" value="ConvertCurrencyLongOfferPayment"/>
                                </enabled>
                            </handler>
                            <!-- установка сообщения о сроках исполнения платежа -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                <parameter name="key" value="operation.transfer.message"/>
                            </handler>
                         </handlers>
                    </next-states>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                    </handlers>
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                    </handlers>
                    <next-states default="DELETED"/>
                </event>
                <event name="REFUSE" description="Отклонить заявку" type="employee">
                    <next-states default="REFUSED"/>
                </event>
            </events>
        </state>

		<state id="SAVED" description="Вы сохранили, но еще не подтвердили документ."
			client-form="/private/payments/confirm.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.forms.meta.ClearOfflineDelayedRowHandler"/>
                <handler class="com.rssl.phizic.business.payments.forms.meta.AddPaymentCommissionSaveHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="RurPayment"/>
                    </enabled>
                </handler>
                <!--проверка максимальной суммы вклада-->
                <handler class="com.rssl.phizic.business.payments.forms.meta.AccountCheckMaxBalanceAmountHandler">
                    <enabled class="com.rssl.phizic.business.payments.forms.meta.AccountCheckMaxBalanceAmountFilter"/>
                </handler>
                <handler class="com.rssl.phizic.business.payments.WriteStateToMonitoringLogHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="ConvertCurrencyPayment;InternalPayment;RurPayment"/>
                    </enabled>
                </handler>
            </handlers>
			<events>
                <event name="DOUNKNOW" description="таймаут" type="client">
                    <next-states default="UNKNOW"/>
                </event>
                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW"/>
                </event>
                <event name="DOWAITCONFIRM" description="Перевод документа в ожидание дополнительной обработки" type="client">
                    <handlers>
                        <sequence-handlers-ref name="confirm"/>
					</handlers>
                    <next-states default="WAIT_CONFIRM">
                       <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                                <parameter name="datePropertyName" value="admissionDate"/>
                                <parameter name="datePropertyType" value="java.util.Calendar"/>
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocTypeAndFormNameFilter">
                                    <parameter name="deniedTypes" value="com.rssl.phizic.gate.payments.InternalCardsTransfer;
                                                                         com.rssl.phizic.gate.payments.ExternalCardsTransferToOurBank;
                                                                         com.rssl.phizic.gate.payments.ExternalCardsTransferToOtherBank"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SimpleBusinessDocumentDateAction">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                    <parameter name="className" value="com.rssl.phizic.gate.payments.InternalCardsTransfer;
                                                                       com.rssl.phizic.gate.payments.ExternalCardsTransferToOurBank;
                                                                       com.rssl.phizic.gate.payments.ExternalCardsTransferToOtherBank"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.AddOrUpdateReminderStateHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                       </handlers>
                    </next-states>
                </event>
				<event name="CONFIRM" description="Отправка документа клиентом" type="client" lock="true">
					<handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                           <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                               <parameter name="whiteList" value="ExternalProviderPayment;FNSPayment;AirlineReservationPayment"/>
                           </enabled>
                        </handler>
                        <!-- Проверка изменения в ОМС  -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.IMAOpeningClaimHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="IMAOpeningClaim"/>
                                </enabled>
                        </handler>
                        <!-- Проверка корректности выбранного ВСП для открытия ОМС  -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.IMAOpeningClaimOfficeHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="IMAOpeningClaim"/>
                                </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedAccountOpeningClaimHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedInternalTransferHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="InternalPayment;IMAPayment;ConvertCurrencyPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedRurPaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="RurPayment;JurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedBlockingCardClaimHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="BlockingCardClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedLoanPaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="LoanPayment"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedBillingPaymentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ExternalProviderESBPaymentFilter"/>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.DenyOfflineStateByCommissionSettingHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                               <parameter name="whiteList" value="InternalPayment; ConvertCurrencyPayment; IMAPayment; RurPayment; IMAOpeningClaim; AccountOpeningClaim; AccountOpeningClaimWithClose"/>
                           </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedExternalProviderPaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>

                        <sequence-handlers-ref name="confirm"/>

                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="WRITE_OFF"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.WriteConfirmChannelToMonitoringLogHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ConvertCurrencyPayment;InternalPayment;RurPayment"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.IncrementPromoCodeHandler">
                             <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                            </enabled>
                        </handler>
					</handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.OfflineDelayedCondition" state="OFFLINE_DELAYED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.AddOrUpdateReminderStateHandler"/>
                                <!-- сброс текстовки -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            </handlers>
                        </next-state>
                        <sequence-next-states-ref name="confirm"/>

                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningMainDocumentHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.AccountPaymentPrepareHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                    <parameter name="className" value="com.rssl.phizic.gate.payments.AccountToCardTransfer;
                                                                       com.rssl.phizic.gate.payments.ClientAccountsTransfer;
                                                                       com.rssl.phizic.gate.payments.AccountIntraBankPayment;
                                                                       com.rssl.phizic.gate.payments.AccountRUSPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="blackList" value="ConvertCurrencyLongOfferPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.AddOrUpdateReminderStateHandler"/>
                            <!-- установка сообщения о сроках исполнения платежа -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                <parameter name="key" value="operation.transfer.message"/>
                            </handler>
                         </handlers>
                    </next-states>
                    <post-next-states>
                        <post-next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.UnknowNextStateCondition" state="UNKNOW"/>
                        <post-next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.ExecutedNextStateCondition" state="EXECUTED">
                            <handlers>
                                <sequence-handlers-ref name="executed_handlers"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                    <parameter name="state" value="EXECUTED"/>
                                </handler>
                            </handlers>
                        </post-next-state>
                    </post-next-states>
                </event>
				<event name="EDIT" description="Редактирование документа" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareEditDocumentHandler"/>
                    </handlers>
                    <next-states default="INITIAL"/>
				</event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="REFUSED"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
			</events>
		</state>

        <state id="UNKNOW" description="Документ подтвержден и передан на обработку в банк."
			employee-form="/claims/claim.do"
            system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"
            client-form="/private/payments/view.do">
            <events>
                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW"/>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="ERROR"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="ERROR"/>
                </event>
                 <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="REFUSED"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REPEAT_SEND" description="Подтверждение документа системой" type="system">
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.AccountIMATypeOperationCondition"
                                    state="EXECUTED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.BusinessDocumentRepeatSendHandler"/>
                                <!-- сброс текстовки -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                                <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                        <parameter name="whiteList" value="sms"/>
                                    </enabled>
                                </handler>
                            </handlers>
                        </next-state>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.BusinessDocumentRepeatSendHandler"/>
                            <!-- установка сообщения о сроках исполнения платежа -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                <parameter name="key" value="operation.transfer.message"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="EXECUTE" description="Подтверждение документа сотрудником" type="employee">
                    <handlers>
                        <!-- BUG039919: Сообщение клиенту при оплате со вклада через шаблон 40 ТБ -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>

                    </handlers>
                    <next-states default="EXECUTED">
                        <sequence-next-states-ref name="tickets_waiting"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <!-- Смена статуса интернет-заказа в EInvoicing -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                                <parameter name="state" value="EXECUTED"/>
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="EXECUTE" description="Подтверждение документа системой" type="system">
                     <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                         <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                             <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                 <parameter name="whiteList" value="sms"/>
                             </enabled>
                         </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <sequence-next-states-ref name="tickets_waiting"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <!-- Смена статуса интернет-заказа в EInvoicing -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                                <parameter name="state" value="EXECUTED"/>
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="REFUSED"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="REFUSED"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
            </events>
		</state>

        <state id="DELAYED_DISPATCH" description="Ожидается обработка документа в банке."
            client-form="/private/payments/view.do"
			employee-form="/claims/claim.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.forms.meta.ClearOfflineDelayedRowHandler"/>

                <handler class="com.rssl.phizic.business.payments.WriteStateToMonitoringLogHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="ConvertCurrencyPayment;InternalPayment;RurPayment"/>
                    </enabled>
                </handler>
            </handlers>
			<events>
                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW"/>
                </event>

                <event name="DISPATCH" description="Отправка документа клиентом" type="system" >
                    <handlers>
                        <!-- Хэндлеры проверки технологических перерывов -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedAccountOpeningClaimHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedInternalTransferHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="InternalPayment;IMAPayment;ConvertCurrencyPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedRurPaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="RurPayment;JurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedBlockingCardClaimHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="BlockingCardClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedLoanPaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="LoanPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedBillingPaymentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ExternalProviderESBPaymentFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckCommissionSumAction">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.ExternalProviderESBPaymentFilter"/>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckOfflineDelayedHandler"/>
                        <!-- BUG039919: Сообщение клиенту при оплате со вклада через шаблон 40 ТБ -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningClaimActualDateHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningClaimFilter"/>
                        </handler>
                        <!-- Проверка кредита на незакрытость и отображаемость в системе -->
                        <handler class="com.rssl.phizic.business.payments.ValidateLoanVisibilityHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="LoanPayment"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckDebtsSplittingHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.LoanTransfer"/>
                            </enabled>
                        </handler>
						<handler class="com.rssl.phizic.business.payments.CheckRateDidntChangeHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="InternalPayment;ConvertCurrencyPayment;AccountOpeningClaim;IMAPayment;IMAOpeningClaim;"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningTypeHandler">
							<enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim"/>
							</enabled>
						</handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningChangeTermsHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim"/>
							</enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                           <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                               <parameter name="whiteList" value="ExternalProviderPayment;FNSPayment;AirlineReservationPayment"/>
                           </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeDepositMinimumBalanceHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ChangeDepositMinimumBalanceClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningMainDocumentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                            </enabled>
                        </handler>
						<handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="blackList" value="ConvertCurrencyLongOfferPayment"/>
                            </enabled>
                        </handler>
					</handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.ESBERIBPaymentsCondition" state="EXECUTED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                                <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                        <parameter name="whiteList" value="sms"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.UpdateLongOfferLinksHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.LongOfferClaimFilter"/>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.UpdateAccountLinksHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningClaimFilter"/>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.ima.UpdateIMAccountLinksHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.ima.IMAOpeningClaimFilter"/>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.UpdateAccountTargetHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningClaimFilter"/>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                    <parameter name="state" value="EXECUTED"/>
                                </handler>
                             </handlers>
                        </next-state>
                        <handlers>
                            <!-- установка сообщения о сроках исполнения платежа -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                <parameter name="key" value="operation.transfer.message"/>
                            </handler>
                        </handlers>
                    </next-states>
                    <post-next-states>
                        <post-next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.UnknowNextStateCondition" state="UNKNOW"/>
                        <post-next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.ExecutedNextStateCondition" state="EXECUTED">
                            <handlers>
                                <sequence-handlers-ref name="executed_handlers"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                    <parameter name="state" value="EXECUTED"/>
                                </handler>
                            </handlers>
                        </post-next-state>
                    </post-next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment;RurPayment"/>
                            </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="REFUSED"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="ERROR"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="ERROR"/>
                </event>
                <event name="EXECUTE" description="Исполнение документа сотрудником банка" type="employee">
                    <handlers>
                         <!-- BUG039919: Сообщение клиенту при оплате со вклада через шаблон 40 ТБ -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment"/>
                            </enabled>
                        </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
       				</handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <!-- Смена статуса интернет-заказа в EInvoicing -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                                <parameter name="state" value="EXECUTED"/>
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ исполнения документа сотрудником банка" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment;RurPayment"/>
                            </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="REFUSED"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
            </events>
		</state>

        <state id="OFFLINE_DELAYED" description="Ожидается обработка документа в банке."
            client-form="/private/payments/view.do"
			employee-form="/claims/claim.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.forms.meta.ClearOfflineDelayedRowHandler"/>
            </handlers>
			<events>
                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW"/>
                </event>

                <event name="DISPATCH" description="Отправка документа клиентом" type="system" >
                    <handlers>

                        <!-- проверка на операционное время -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.JobDelayedStateHandler" />

                        <handler class="com.rssl.phizic.business.payments.CheckRateDidntChangeHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="InternalPayment;ConvertCurrencyPayment;AccountOpeningClaim;IMAPayment;IMAOpeningClaim;"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedAccountOpeningClaimHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountOpeningClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedInternalTransferHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="InternalPayment;IMAPayment;ConvertCurrencyPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedRurPaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="RurPayment;JurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedBlockingCardClaimHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="BlockingCardClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.OfflineDelayedLoanPaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="LoanPayment"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.BlockingCardClaimHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="BlockingCardClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.ValidatePaymentAccountHandler">
                            <parameter name="checkType" value="payer"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="RurPayment;LoanPayment;JurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.ValidatePaymentAccountHandler">
                            <parameter name="checkType" value="both"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="InternalPayment;IMAPayment;ConvertCurrencyPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.ValidatePaymentAmountAction">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="RurPayment;LoanPayment;InternalPayment;IMAPayment;JurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                            <parameter name="datePropertyName" value="admissionDate"/>
                            <parameter name="datePropertyType" value="java.util.Calendar"/>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocTypeAndFormNameFilter">
                                <parameter name="whiteList" value="RurPayment;InternalPayment;LoanPayment;IMAPayment;ConvertCurrencyPayment;JurPayment"/>
                                <parameter name="deniedTypes" value="com.rssl.phizic.gate.payments.InternalCardsTransfer;
                                                                     com.rssl.phizic.gate.payments.ExternalCardsTransferToOurBank;
                                                                     com.rssl.phizic.gate.payments.ExternalCardsTransferToOtherBank"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SimpleBusinessDocumentDateAction">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.InternalCardsTransfer;
                                                                   com.rssl.phizic.gate.payments.ExternalCardsTransferToOurBank;
                                                                   com.rssl.phizic.gate.payments.ExternalCardsTransferToOtherBank"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckImmediatePaymentDateHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="InternalPayment;RurPayment;LoanPayment;ConvertCurrencyPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckLongOfferStartDateHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="InternalPayment;RurPayment;LoanPayment;ConvertCurrencyPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckDebtsSplittingHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.LoanTransfer"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DocumentSumValidationHandler">
                            <parameter name="useInTemplate" value="false"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="RurPayment;InternalPayment;IMAPayment;ConvertCurrencyPayment;JurPayment"/>
                            </enabled>
                        </handler>
                        <!-- CHG030960: запретить клиентам оплачивать кредит во внеоперационное время  -->
                        <handler class="com.rssl.phizic.business.payments.ValidateLoanReceptionTimeHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="LoanPayment"/>
                            </enabled>
                        </handler>
                        <!-- Проверка кредита на незакрытость и отображаемость в системе -->
                        <handler class="com.rssl.phizic.business.payments.ValidateLoanVisibilityHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="LoanPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                           <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                               <parameter name="whiteList" value="ExternalProviderPayment;FNSPayment;AirlineReservationPayment"/>
                           </enabled>
                        </handler>
					</handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.OfflineDelayedCondition" state="OFFLINE_DELAYED">
                            <handlers>
                                <!-- сброс текстовки -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            </handlers>
                        </next-state>
                        <next-state condition="com.rssl.phizic.business.ext.sbrf.payments.forms.meta.ESBERIBPaymentsCondition" state="EXECUTED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningMainDocumentHandler">
                                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                        <parameter name="whiteList" value="AccountOpeningClaim;AccountOpeningClaimWithClose"/>
                                    </enabled>
                                </handler>

                                <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareDocumentHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.ExternalProviderESBPaymentFilter"/>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.BillingPaymentRequisitesSufficientHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.ExternalProviderESBPaymentFilter"/>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckCommissionSumAction">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.ExternalProviderESBPaymentFilter"/>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                                <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                        <parameter name="whiteList" value="sms"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.UpdateLongOfferLinksHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.LongOfferClaimFilter"/>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.UpdateAccountLinksHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.AccountOpeningClaimFilter"/>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.ima.UpdateIMAccountLinksHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.ima.IMAOpeningClaimFilter"/>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                    <parameter name="state" value="EXECUTED"/>
                                </handler>
                             </handlers>
                        </next-state>
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.BlockingCardClaimCondition" state="EXECUTED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                             </handlers>
                        </next-state>
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.CardsTransferCondition" state="EXECUTED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                                <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                        <parameter name="whiteList" value="sms"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                                <handler class="com.rssl.phizic.messaging.payments.handlers.MessageToReceiverHandler">
                                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                        <parameter name="whiteList" value="RurPayment"/>
                                    </enabled>
                                </handler>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                    <parameter name="state" value="EXECUTED"/>
                                </handler>
                             </handlers>
                        </next-state>
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.DelayedStateCondition" state="DELAYED_DISPATCH">
                            <handlers>
                                <!-- сброс текстовки -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            </handlers>
                        </next-state>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                            <!-- установка сообщения о сроках исполнения платежа -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                <parameter name="key" value="operation.transfer.message"/>
                            </handler>
                        </handlers>
                    </next-states>
                    <post-next-states>
                        <post-next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.UnknowNextStateCondition" state="UNKNOW"/>
                        <post-next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.ExecutedNextStateCondition" state="EXECUTED">
                            <handlers>
                                <sequence-handlers-ref name="executed_handlers"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                    <parameter name="state" value="EXECUTED"/>
                                </handler>
                            </handlers>
                        </post-next-state>
                    </post-next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.messaging.payments.handlers.SmsOfRefuseOperationHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="blackList" value="sms"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment;RurPayment"/>
                            </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="REFUSED"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.messaging.payments.handlers.SmsOfRefuseOperationHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="blackList" value="sms"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="ERROR"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="ERROR"/>
                </event>
                <event name="EXECUTE" description="Исполнение документа сотрудником банка" type="employee">
                    <handlers>
                         <!-- BUG039919: Сообщение клиенту при оплате со вклада через шаблон 40 ТБ -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment"/>
                            </enabled>
                        </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
       				</handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <!-- Смена статуса интернет-заказа в EInvoicing -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                                <parameter name="state" value="EXECUTED"/>
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ исполнения документа сотрудником банка" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.messaging.payments.handlers.SmsOfRefuseOperationHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="blackList" value="sms"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment;RurPayment"/>
                            </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="REFUSED"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="RECALL" description="Отзыв документа" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment;RurPayment"/>
                            </enabled>
                         </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <handler class="com.rssl.phizic.messaging.payments.handlers.SmsOfRefuseOperationHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="blackList" value="sms"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="RECALLED"/>
                </event>
            </events>
		</state>

		<state id="DISPATCHED" description="Документ подтвержден и передан на обработку в банк."
			client-form="/private/payments/view.do"
			employee-form="/claims/claim.do"
			system-resolver="com.rssl.phizic.business.payments.ABSSystemNameResolver">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.WriteStateToMonitoringLogHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="ConvertCurrencyPayment;InternalPayment;RurPayment"/>
                    </enabled>
                </handler>
            </handlers>
			<events>
                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW"/>
                </event>

                <event name="REPEAT_SEND" description="Подтверждение документа системой" type="system">
                    <next-states default="DISPATCHED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                               <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                   <parameter name="whiteList" value="ExternalProviderPayment;FNSPayment;AirlineReservationPayment"/>
                               </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.BusinessDocumentRepeatSendHandler"/>
                            <!-- установка сообщения о сроках исполнения платежа -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                <parameter name="key" value="operation.transfer.message"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
				<event name="SUCCESS" description="Выдан" type="system">
                    <next-states default="SUCCESSED">
                        <handlers>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                        </handlers>
                    </next-states>
				</event>
				<event name="EXECUTE" description="Подтверждение документа системой" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="blackList" value="BlockingCardClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <sequence-next-states-ref name="tickets_waiting"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <!-- Смена статуса интернет-заказа в EInvoicing -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                                <parameter name="state" value="EXECUTED"/>
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
				</event>
                <event name="EXECUTE" description="Подтверждение документа сотрудником" type="employee">
                    <handlers>
                        <!-- BUG039919: Сообщение клиенту при оплате со вклада через шаблон 40 ТБ -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAccountTemplateForSomeTBHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="blackList" value="BlockingCardClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <sequence-next-states-ref name="tickets_waiting"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="blackList" value="AccountChangeInterestDestinationClaim;ChangeDepositMinimumBalanceClaim"/>
                                </enabled>
                            </handler>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <!-- Смена статуса интернет-заказа в EInvoicing -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                                <parameter name="state" value="EXECUTED"/>
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
				<event name="PARTLY_EXECUTED" description="Подтверждение документа системой ЦОД" type="system">
                    <next-states default="PARTLY_EXECUTED"/>
				</event>
				<event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                          <!-- откатываем лимит -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment;RurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="REFUSED"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
				</event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment;RurPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="REFUSED"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
				</event>
				<event name="ERROR" description="При работе с документом произошла ошибка" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                        <!-- откатываем лимит -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="JurPayment;RurPayment"/>
                            </enabled>
                        </handler>
                        <!-- Смена статуса интернет-заказа в EInvoicing -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ChangeOrderStateHandler">
                            <parameter name="state" value="ERROR"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="ExternalProviderPayment;AirlineReservationPayment"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="ERROR"/>
				</event>
			</events>
		</state>

		<state id="SUCCESSED" description="Платеж успешно исполнен банком: денежные средства переведены на счет получателя платежа."
			client-form="/private/payments/view.do"
			employee-form="/claims/claim.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

		<state id="TICKETS_WAITING" description="Ожидание получения списка купленных билетов"
			client-form="/private/payments/view.do"
			employee-form="/claims/claim.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="EXECUTE" description="Исполнение документа" type="system">
                    <next-states default="EXECUTED"/>
                </event>
                <event name="EXECUTE" description="Исполнение документа сотрудником" type="employee">
                    <next-states default="EXECUTED"/>
                </event>
            </events>
        </state>

		<state id="PARTLY_EXECUTED" description="Документ подтвержден и передан на обработку в банк."
			client-form="/private/payments/view.do"
			employee-form="/claims/claim.do"
            system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="EXECUTE" description="Подтверждение документа системой" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="blackList" value="BlockingCardClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
	            <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                    </handlers>
		            <next-states default="ERROR"/>
	            </event>
            </events>
        </state>

        <state id="EXECUTED" description="Операция успешно исполнена банком."
			client-form="/private/payments/view.do"
			employee-form="/claims/claim.do"
            system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.WriteStateToMonitoringLogHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="ConvertCurrencyPayment;InternalPayment;RurPayment"/>
                    </enabled>
                </handler>
            </handlers>

            <events>
                <event name="RECALL" description="Отзыв документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RollbackUserLimitHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                    </handlers>
                    <next-states default="RECALLED"/>
                </event>
            </events>
        </state>

		<state id="REFUSED" description="Вам отказано в исполнении операции по какой-либо причине."
			client-form="/private/payments/view.do"
			employee-form="/claims/claim.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <handlers>
                <handler class="com.rssl.phizic.business.payments.WriteStateToMonitoringLogHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="ConvertCurrencyPayment;InternalPayment;RurPayment"/>
                    </enabled>
                </handler>
            </handlers>
        </state>

		<state id="ERROR" description="Платеж не может быть исполнен, Вам необходимо обратиться в банк."
			client-form="/private/payments/view.do"
			employee-form="/claims/claim.do"
            system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.WriteStateToMonitoringLogHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="ConvertCurrencyPayment;InternalPayment;RurPayment"/>
                    </enabled>
                </handler>
            </handlers>
            <events>
                <event name="EXECUTE" description="Подтверждение документа сотрудником" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="blackList" value="BlockingCardClaim"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                <parameter name="whiteList" value="sms"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <!-- сброс текстовки -->
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                           <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                               <parameter name="whiteList" value="sms"/>
                           </enabled>
                         </handler>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
		    </events>
        </state>

        <state id="RECALLED" description="Документ отозван Вами по какой-либо причине."
			client-form="/private/payments/view.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state id="DELETED" description="Документ удален."
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>
	</states>

	<states name="RecallPaymentStateMachine" inital-state="INITIAL" saveNodeInfo="true"
	        description="МС документа, не требующего подтверждения сотрудником банка и направленного прямо в ритейл">

		<state
			id="INITIAL" description="Вы перешли к форме отзыва документа."
			client-form="/private/payments/payment.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
			<events>
				<event name="SAVE" description="Сохранение документа клиентом" type="client">
                    <next-states default="SAVED"/>
				</event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
			</events>
		</state>
		<state
			id="SAVED" description="Вы сохранили, но еще не подтвердили отзыв документа."
			client-form="/private/payments/confirm.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
			<events>
				<event name="CONFIRM" description="Отправка документа клиентом" type="client">
					<handlers>
						<handler class="com.rssl.phizic.business.payments.forms.meta.WithdrawBusinessDocumentSender"/>
					</handlers>
                    <next-states default="EXECUTED"/>
				</event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
			</events>
		</state>
		<state
			id="EXECUTED" description="Документ успешно отозван Вами из банка."
			client-form="/private/payments/view.do"
			employee-form="/claims/claim.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
		</state>
        <state id="DELETED" description="Документ удален."
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>
	</states>

    <!-- ################################################################################################# -->

    <states name="OnLinePaymentStateMachine" inital-state="INITIAL" saveNodeInfo="true"
	        description="Машина состояний он-лайн платежей без возможности отложенной обработки">
		<state
			id="INITIAL"
            description="Вы создали, но еще не сохранили документ"
			client-form="/private/payments/payment.do"
            system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

			<events>
				<event name="SAVE" description="Сохранение документа клиентом" type="client">
					<handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.IsESBSupportedHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.AccountClosingPaymentToCard;com.rssl.phizic.gate.payments.AccountClosingPaymentToAccount"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.OwnerCreationTypeHandler">
                            <parameter name="creationType" value="UDBO"/>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                                <parameter name="className" value="com.rssl.phizic.gate.payments.AccountClosingPaymentToCard;com.rssl.phizic.gate.payments.AccountClosingPaymentToAccount"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.ValidateWayCardHandler"/>

                        <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.AccountToCardConvertionSRBDenyHandler">
                            <parameter name="error-message" value="Выберите счет и карту с одинаковой валютой"/>
                        </handler>


                        <handler class="com.rssl.phizic.business.payments.forms.meta.ReceptionTimeDelayedStateHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
								<parameter name="whiteList" value="AccountClosingPayment"/>
                            </enabled>
                        </handler>

                        <!-- проверка на то что операционное время -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DelayedStateHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
								<parameter name="blackList" value="AccountClosingPayment"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountClosingPaymentPrepareHandler">
                            <parameter name="state" value="INITIAL"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
								<parameter name="whiteList" value="AccountClosingPayment"/>
                            </enabled>
                        </handler>

                        <handler  class="com.rssl.phizic.business.payments.forms.meta.TariffPlanUsagePaymentHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountClosingPayment;"/>
                            </enabled>
                        </handler>

                        <!--проверка максимальной суммы вклада-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountCheckMaxBalanceAmountHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.AccountCheckMaxBalanceAmountFilter"/>
                        </handler>
					</handlers>
                    <next-states default="SAVED">
                        <!-- Condition для сообщения об изменении остатка нулевого вклада -->
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.ChargeOffAmountNotZeroCondition"       state="INITIAL"/>
                    </next-states>
				</event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
			</events>
		</state>

		<state id="SAVED"
               description="Вы сохранили, но еще не подтвердили заявку."
			   client-form="/private/payments/confirm.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

			<events>
                <event name="DOWAITCONFIRM" type="client" description="Ожидает дополнительной обработки">
                    <handlers>
                        <!-- проверка на то что оперционное время -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DelayedStateHandler"/>

                        <!-- Проверка счетов -->
                        <handler class="com.rssl.phizic.business.payments.ValidatePaymentAccountHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountClosingPayment"/>
                            </enabled>
                        </handler>


                        <!-- проверка даты закрытия вклада(счета) и обновление полей в случае несовпадения дат создания заявки и подтверждения -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountClosingPaymentPrepareHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DateChangedFilter">
                                <parameter name="whiteList" value="AccountClosingPayment"/>
                            </enabled>
                        </handler>
                    </handlers>

                    <next-states default="WAIT_CONFIRM">
                    </next-states>
                </event>
				<event name="CONFIRM" description="Отправка документа клиентом" type="client" lock="true">
					<handlers>
                        <!-- проверка на то что оперционное время -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DelayedStateHandler"/>

                        <!-- Проверка счетов -->
                        <handler class="com.rssl.phizic.business.payments.ValidatePaymentAccountHandler">
							<enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
								<parameter name="whiteList" value="AccountClosingPayment"/>
							</enabled>
						</handler>


                        <!-- проверка даты закрытия вклада(счета) и обновление полей в случае несовпадения дат создания заявки и подтверждения -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountClosingPaymentPrepareHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DateChangedFilter">
                                <parameter name="whiteList" value="AccountClosingPayment"/>
                            </enabled>
                        </handler>

                        <!--Проверка изменения курса валют-->
                        <handler class="com.rssl.phizic.business.payments.CheckRateDidntChangeHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountClosingPayment"/>
                            </enabled>
                        </handler>

                        <!--Удаление цели клиента, привязанной к вкладу-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DeleteClientAccountTargetHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountClosingPayment"/>
                            </enabled>
                        </handler>

					</handlers>

                    <next-states default="EXECUTED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.ChargeOffAmountNotZeroCondition"       state="INITIAL"/>
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.FieldsAreChangedStateObjectCondition" state="SAVED"/>

                        <next-state condition="com.rssl.phizic.business.statemachine.AlwaysTrueStateObjectCondition" state="EXECUTED">
                            <handlers>
                                <!-- установка даты приема документа банком -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                                    <parameter name="datePropertyName" value="admissionDate"/>
                                    <parameter name="datePropertyType" value="java.util.Calendar"/>
                                </handler>
                                <!-- отсылка документа -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                                <!-- обработка документа -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>

                                <!-- установка сообщения о сроках исполнения платежа -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                    <parameter name="key" value="operation.completed.message"/>
                                </handler>
                            </handlers>
                        </next-state>
                    </next-states>
                </event>
				<event name="EDIT" description="Редактирование документа" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PrepareEditDocumentHandler"/>
                    </handlers>
                    <next-states default="INITIAL"/>
				</event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
                <event name="DOUNKNOW" description="таймаут" type="client">
                    <next-states default="UNKNOW"/>
                </event>
                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW"/>
                </event>
			</events>
		</state>
        <state id="WAIT_CONFIRM" description="Документ, ожидающий дополнительного подтверждения"
                       client-form="/private/payments/view.do"
                       system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="CONFIRM" description="Отправка документа клиентом" type="employee" lock="true">
                    <handlers>
                        <!-- проверка на то что оперционное время -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DelayedStateHandler"/>

                        <!-- Проверка счетов -->
                        <handler class="com.rssl.phizic.business.payments.ValidatePaymentAccountHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountClosingPayment"/>
                            </enabled>
                        </handler>


                        <!-- проверка даты закрытия вклада(счета) и обновление полей в случае несовпадения дат создания заявки и подтверждения -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.AccountClosingPaymentPrepareHandler">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.DateChangedFilter">
                                <parameter name="whiteList" value="AccountClosingPayment"/>
                            </enabled>
                        </handler>

                        <!--Проверка изменения курса валют-->
                        <handler class="com.rssl.phizic.business.payments.CheckRateDidntChangeHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountClosingPayment"/>
                            </enabled>
                        </handler>

                        <!--Удаление цели клиента, привязанной к вкладу-->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DeleteClientAccountTargetHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="AccountClosingPayment"/>
                            </enabled>
                        </handler>

                    </handlers>

                    <next-states default="EXECUTED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.ChargeOffAmountNotZeroCondition"       state="INITIAL"/>
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.FieldsAreChangedStateObjectCondition" state="SAVED"/>

                        <next-state condition="com.rssl.phizic.business.statemachine.AlwaysTrueStateObjectCondition" state="EXECUTED">
                            <handlers>
                                <!-- установка даты приема документа банком -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetBusinessDocumentDateAction">
                                    <parameter name="datePropertyName" value="admissionDate"/>
                                    <parameter name="datePropertyType" value="java.util.Calendar"/>
                                </handler>

                                <!-- отсылка документа -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                                <!-- обработка документа -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>

                                <!-- установка сообщения о сроках исполнения платежа -->
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey">
                                    <parameter name="key" value="operation.completed.message"/>
                                </handler>
                            </handlers>
                        </next-state>
                    </next-states>
                </event>

                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW"/>
                </event>

                <event name="REFUSE" description="Отклонить заявку" type="employee">
                    <next-states default="REFUSED"/>
                </event>
            </events>
        </state>
        <state id="EXECUTED"
               description="Операция успешно исполнена банком."
			   client-form="/private/payments/view.do"
			   employee-form="/claims/claim.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state id="REFUSED" description="Заявка на закрытие вклада отклонена Банком."
               client-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state id="DELETED" description="Документ удален."
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state id="UNKNOW" description="Статус документа не определен. Пожалуйста, обратитесь в Контактный центр банка для уточнения информации."
			   client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                    </handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                    </handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <next-states default="ERROR"/>
                </event>
            </events>
        </state>
	</states>

    <!-- ################################################################################################# -->

    <states name="PFRStatementClaimStateMachine" saveNodeInfo="true"
            description="машина состояний заявки на получение выписки из ПФР"
            inital-state="INITIAL">

        <state id="INITIAL" description="Вы перешли к форме заявки на получение выписки из ПФР."
               client-form="/private/payments/payment.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.forms.meta.PFRStatementClaimStartHandler"/>
            </handlers>
            <events>
                <event name="SAVE" description="Сохранение документа клиентом" type="client">
                    <next-states default="SAVED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
            </events>
        </state>

        <state id="DRAFT" description="Частично заполненнный документ"
               client-form="/private/payments/payment.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="SAVE" description="Сохранение документа клиентом" type="client">
                    <next-states default="SAVED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
            </events>
        </state>

        <state id="SAVED" description="Вы сохранили, но еще не подтвердили заявку на получение выписки из ПФР."
               client-form="/private/payments/confirm.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="CONFIRM" description="Отправка документа клиентом" type="client" lock="true">
                    <handlers>
                        <!-- 1. Отправляем заявку на выписку ПФР -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PFRStatementClaimSender"/>
                        <!-- (2) Сразу же загружаем выписку, если она готова -->
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PFRStatementLoader">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.PFRStatementStatusFilter">
                                <parameter name="status" value="AVAILABLE"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="REFUSED">
                        <!-- StatementStatus.READY => EXECUTED -->
                        <next-state condition="com.rssl.phizic.business.statemachine.AlwaysTrueStateObjectCondition" state="EXECUTED"
                                client-message='Заявка успешно обработана! Теперь Вы можете посмотреть выписку. Спасибо, что воспользовались системой "Сбербанк Онлайн"!'>
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PFRStatementClaimFinishHandler"/>
                            </handlers>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.PFRStatementStatusFilter">
                                <parameter name="status" value="READY"/>
                            </enabled>
                        </next-state>
                        <!-- StatementStatus.AVAILABLE => STATEMENT_READY -->
                        <next-state condition="com.rssl.phizic.business.statemachine.AlwaysTrueStateObjectCondition" state="STATEMENT_READY"
                                client-message='Заявка успешно отправлена в Банк! Спасибо, что воспользовались системой "Сбербанк Онлайн"!'>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.PFRStatementStatusFilter">
                                <parameter name="status" value="AVAILABLE"/>
                            </enabled>
                        </next-state>
                        <!-- StatementStatus.NOT_YET_AVAILABLE => DISPATCHED -->
                        <next-state condition="com.rssl.phizic.business.statemachine.AlwaysTrueStateObjectCondition" state="DISPATCHED"
                                client-message='Заявка успешно отправлена в Банк! Спасибо, что воспользовались системой "Сбербанк Онлайн"!'>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.PFRStatementStatusFilter">
                                <parameter name="status" value="NOT_YET_AVAILABLE"/>
                            </enabled>
                        </next-state>
                        <!-- StatementStatus.UNAVAILABLE_DUE_INFO_REQUIRED => DRAFT -->
                        <next-state condition="com.rssl.phizic.business.statemachine.AlwaysTrueStateObjectCondition" state="DRAFT">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.PFRStatementStatusFilter">
                                <parameter name="status" value="UNAVAILABLE_DUE_INFO_REQUIRED"/>
                            </enabled>
                        </next-state>
                        <!-- StatementStatus.UNAVAILABLE_DUE_UNKNOWN_PERSON => REFUSED -->
                        <next-state condition="com.rssl.phizic.business.statemachine.AlwaysTrueStateObjectCondition" state="REFUSED"
                                client-message="Предоставление услуги возможно только после регистрации.">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PFRStatementClaimFinishHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            </handlers>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.PFRStatementStatusFilter">
                                <parameter name="status" value="UNAVAILABLE_DUE_UNKNOWN_PERSON"/>
                            </enabled>
                        </next-state>
                        <!-- StatementStatus.UNAVAILABLE_DUE_FAIL => REFUSED -->
                        <next-state condition="com.rssl.phizic.business.statemachine.AlwaysTrueStateObjectCondition" state="REFUSED"
                                client-message="Предоставление услуги возможно только после регистрации.">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PFRStatementClaimFinishHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            </handlers>
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.PFRStatementStatusFilter">
                                <parameter name="status" value="UNAVAILABLE_DUE_FAIL"/>
                            </enabled>
                        </next-state>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
                <event name="DOUNKNOW" description="таймаут" type="client">
                    <next-states default="UNKNOW"/>
                </event>
            </events>
        </state>

        <state id="DISPATCHED" description="Заявка на получение выписки из ПФР находится в обработке."
               client-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ESBSystemNameResolver">
            <events>
                <event name="STATEMENT_READY" description="КСШ обработала заявку на выписку из ПФР. Выписка готова к получению." type="system">
                    <next-states default="STATEMENT_READY"/>
                </event>
                <event name="EXECUTE" description="КСШ обработала заявку на выписку из ПФР. Выписка успешно получена." type="system">
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.PFRStatementClaimFinishHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="КСШ обработала заявку на выписку из ПФР. Заявка отклонена." type="system">
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.PFRStatementClaimFinishHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
            </events>
        </state>

        <state id="STATEMENT_READY" description="Заявка на получение выписки из ПФР готова к немедленному получению."
               client-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="EXECUTE" description="КСШ обработала заявку на выписку из ПФР. Выписка успешно получена." type="system">
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.PFRStatementClaimFinishHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="КСШ обработала заявку на выписку из ПФР. Выписку так и не удалось получить." type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.PFRStatementClaimFinishHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
            </events>
        </state>

        <state id="EXECUTED" description="Заявка на получение выписки из ПФР успешно выполнена. Выписка получена."
               client-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state id="REFUSED" description="Заявка на получение выписки из ПФР отклонена Банком."
               client-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state id="DELETED" description="Документ удален."
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state id="UNKNOW" description="Статус документа не определен. Пожалуйста, обратитесь в Контактный центр банка для уточнения информации."
			   client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                    </handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                    </handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <next-states default="ERROR"/>
                </event>
            </events>
        </state>
    </states>

    <!-- ################################################################################################# -->

    <states name="CreateAutoPaymentStateMachine" inital-state="INITIAL" description="Машина состояния для автоплатежа" saveNodeInfo="true">

        <sequences-handlers>
            <sequence name="confirm">
               <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAutoPayParametersHandler"/>
               <handler class="com.rssl.phizic.business.payments.forms.meta.SetAutoPayTotalAmountLimitHandler"/>
               <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler"/>
               <handler class="com.rssl.phizic.business.ext.sbrf.payments.handlers.CheckProviderServicePaymentHandler"/>
               <handler class="com.rssl.phizic.business.payments.ValidatePaymentAccountHandler">
                    <parameter name="checkType" value="payer"/>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.SimpleBusinessDocumentDateAction"/>
                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckImmediatePaymentDateHandler"/>
            </sequence>
        </sequences-handlers>

        <state id="INITIAL" client-form="/private/payments/payment.do" description="Частично заполеннный документ"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <handlers>
                <!-- сброс текстовки -->
                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
            </handlers>

           <events>
               <event name="SAVE" description="Сохранить документ как черновик" type="client">
                    <next-states default="DRAFT">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.ErmbPaymentCondition" state="SAVED" description="Сохранение документа клиентом">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAutoPaymentHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.AutoPaymentNextPayDateAction"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultGateValidationHandler"/>
                                <!-- Установка названия услуги и проч. -->
                                <handler class="com.rssl.phizic.business.payments.SetupAutoPaymentHandler"/>
                            </handlers>
                        </next-state>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAutoPaymentDublicatehandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAutoPaymentHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.AutoPaymentNextPayDateAction"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
           </events>
        </state>
        <state id="DRAFT" client-form="/private/payments/payment.do" description="Не полностью заполненый автоплатеж"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="INITIAL" description="Редактирование документа клиентом" type="client">
                    <next-states default="INITIAL"/>
                </event>
                <event name="SAVE" description="Сохранение документа клиентом"  type="client">
                    <next-states default="SAVED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultGateValidationHandler"/>
                            <!-- Установка названия услуги и проч. -->
                            <handler class="com.rssl.phizic.business.payments.SetupAutoPaymentHandler"/>
                        </handlers>
                    </next-states>
				</event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
             </events>
        </state>

        <state id="WAIT_CONFIRM" description="Документ, ожидающий дополнительного подтверждения" client-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="DOUNKNOW" description="таймаут" type="employee">
                    <next-states default="UNKNOW"/>
                </event>

                <event name="CONFIRM" type="employee">
                    <next-states default="DISPATCHED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAutoPayParametersHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetAutoPayTotalAmountLimitHandler"/>

                            <handler class="com.rssl.phizic.business.payments.forms.meta.CheckConfirmDateHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                         </handlers>
                    </next-states>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>

                <event name="REFUSE" description="Отклонить заявку" type="employee">
                    <next-states default="REFUSED"/>
                </event>
            </events>
        </state>

        <state id="SAVED" client-form="/private/payments/confirm.do" description="Вы сохранили, но еще не подтвердили платеж."
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
           <events>
                <event name="DOUNKNOW" description="таймаут" type="client">
                    <next-states default="UNKNOW"/>
                </event>

                <event name="DOWAITCONFIRM" description="Перевод документа в ожидание дополнительной обработки" type="client">
                    <handlers>
                        <sequence-handlers-ref name="confirm"/>
                    </handlers>
                    <next-states default="WAIT_CONFIRM">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
				<event name="CONFIRM" description="Отправка документа клиентом" type="client" lock="true">
					<handlers>
    				    <sequence-handlers-ref name="confirm"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
					</handlers>
                    <next-states default="DISPATCHED" />
                </event>
				<event name="EDIT" description="Редактирование документа" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.AutoPaymentNextPayDateAction">
                            <enabled class="com.rssl.phizic.business.payments.forms.meta.GateDocumentTypeFilter">
                               <parameter name="className" value="com.rssl.phizic.gate.payments.autopayment.CreateAutoPayment"/>
                           </enabled>
                        </handler>
                    </handlers>
                    <next-states default="DRAFT"/>
				</event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
			</events>
        </state>

        <state id="DISPATCHED" client-form="/private/payments/view.do"
               description="Документ подтвержден и передан на обработку в банк."
               system-resolver="com.rssl.phizic.business.payments.IQWaveSystemNameResolver">
           <events>
                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW"/>
                </event>

                <event name="EXECUTE" description="Подтверждение документа системой" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>

                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="RECALL" description="Отзыв документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RecallBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                    </handlers>
                    <next-states default="RECALLED"/>
                </event>

                <event name="ERROR" description="При работе с документом произошла ошибка" type="system">
                    <next-states default="ERROR"/>
                </event>
            </events>
        </state>

        <state id="UNKNOW" description="Статус документа не определен. Пожалуйста, обратитесь в Контактный центр банка для уточнения информации."
			   client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="EXECUTE" description="Подтверждение документа сотрудником" type="employee">
                     <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <next-states default="ERROR"/>
                </event>
            </events>
		</state>

        <state
			id="REFUSED" description="Вам отказано в исполнении операции по какой-либо причине."
			client-form="/private/payments/view.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

		<state
			id="RECALLED" description="Документ отозван Вами по какой-либо причине."
			client-form="/private/payments/view.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state
			id="EXECUTED" description="Заявка успешно исполнена. Данный автоплатеж будет показан в списке на странице «Платежи и операции»"
			client-form="/private/payments/view.do"
            system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state
			id="ERROR" description="Платеж не может быть исполнен, Вам необходимо обратиться в банк."
			client-form="/private/payments/view.do"
			employee-form="/claims/claim.do"
            system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="EXECUTE" description="Подтверждение документа сотрудником" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="EXECUTE" description="Подтверждение документа системой" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа системой" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
		    </events>
        </state>

        <state id="DELETED" description="Документ удален."
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

    </states>

    <!-- ################################################################################################# -->

    <states name="EditOrRefuseAutoPaymentStateMachine" inital-state="INITIAL" description="Машина состояния для автоплатежа" saveNodeInfo="true">
        <state id="INITIAL" client-form="/private/payments/payment.do"
               description="Частично заполеннный документ"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAutoPaymentStatusHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="EditAutoPaymentPayment;RefuseAutoPaymentPayment"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.ValidatePaymentAccountHandler">
                    <parameter name="checkType" value="payer"/>
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="EditAutoPaymentPayment"/>
                    </enabled>
                </handler>
                <!--отмена автоплатежа доступна для арестованной карты-->
                <handler class="com.rssl.phizic.business.payments.ValidatePaymentAccountHandler">
                    <parameter name="checkType" value="payer"/>
                    <parameter name="allowArrestedType" value="allowArrestedForPayerAndReciever"/>
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="RefuseAutoPaymentPayment"/>
                    </enabled>
                </handler>
                <!-- сброс текстовки -->
                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
           </handlers>
           <events>
                 <event name="SAVE" description="Сохранение документа клиентом"  type="client">
                    <next-states default="SAVED">
                        <handlers>
                            <handler  class="com.rssl.phizic.business.payments.forms.meta.DefaultGateValidationHandler"/>
                            <!-- Установка названия услуги и проч. -->
                            <handler class="com.rssl.phizic.business.payments.SetupAutoPaymentHandler"/>
                        </handlers>
                    </next-states>
				</event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
             </events>
        </state>

        <state id="SAVED" client-form="/private/payments/confirm.do"
               description="Вы сохранили, но еще не подтвердили документ."
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
           <events>
                <event name="DOUNKNOW" description="таймаут" type="client">
                    <next-states default="UNKNOW"/>
                </event>

				<event name="CONFIRM" description="Отправка документа клиентом" type="client" lock="true">
					<handlers>
    				    <handler class="com.rssl.phizic.business.payments.ValidatePaymentAccountHandler">
							<parameter name="checkType" value="payer"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="EditAutoPaymentPayment"/>
                            </enabled>
						</handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAutoPayParametersHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="EditAutoPaymentPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetAutoPayTotalAmountLimitHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="EditAutoPaymentPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.handlers.CheckBillingPaymentChargeOffCardHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="EditAutoPaymentPayment"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.SimpleBusinessDocumentDateAction"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckImmediatePaymentDateHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="EditAutoPaymentPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
					</handlers>
                    <next-states default="DISPATCHED" />
                </event>
				<event name="EDIT" description="Редактирование документа" type="client">
                    <next-states default="INITIAL"/>
				</event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
                <event name="DOWAITCONFIRM" description="Перевод документа в ожидание дополнительной обработки" type="client">
                    <handlers>
    				    <handler class="com.rssl.phizic.business.payments.ValidatePaymentAccountHandler">
							<parameter name="checkType" value="payer"/>
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="EditAutoPaymentPayment"/>
                            </enabled>
						</handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAutoPayParametersHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="EditAutoPaymentPayment"/>
                            </enabled>
                        </handler>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetAutoPayTotalAmountLimitHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="EditAutoPaymentPayment"/>
                            </enabled>
                        </handler>

                        <handler class="com.rssl.phizic.business.payments.forms.meta.SimpleBusinessDocumentDateAction"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CheckImmediatePaymentDateHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="EditAutoPaymentPayment"/>
                            </enabled>
                        </handler>
					</handlers>
                    <next-states default="WAIT_CONFIRM">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
			</events>
        </state>

        <state id="WAIT_CONFIRM" description="Документ, ожидающий дополнительного подтверждения" client-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="DOUNKNOW" description="таймаут" type="employee">
                    <next-states default="UNKNOW"/>
                </event>

                <event name="CONFIRM" type="employee">
                    <next-states default="DISPATCHED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CheckAutoPayParametersHandler">
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="EditAutoPaymentPayment"/>
                                </enabled>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CheckConfirmDateHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                         </handlers>
                    </next-states>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>

                <event name="REFUSE" description="Отклонить заявку" type="employee">
                    <next-states default="REFUSED"/>
                </event>
            </events>
        </state>

        <state id="DISPATCHED" client-form="/private/payments/view.do"
               description="Документ подтвержден и передан на обработку в банк."
               system-resolver="com.rssl.phizic.business.payments.IQWaveSystemNameResolver">
           <events>
                <event name="DOUNKNOW" description="таймаут" type="system">
                    <next-states default="UNKNOW"/>
                </event>

                <event name="EXECUTE" description="Подтверждение документа системой" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                    </handlers>
                    <!-- В зависимости от формы платежа(редактирование/отказ) описание статуса должно быть различно-->
                    <next-states default="EXECUTED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.RefuseAutoPaymentTypeCondition" state="EXECUTED" description="Заявка исполнена. Выполнение данного автоплатежа отменено.">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                                <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                    <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                        <parameter name="whiteList" value="sms"/>
                                    </enabled>
                                </handler>
                            </handlers>
                        </next-state>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>

                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="RECALL" description="Отзыв документа" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.RecallBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                    </handlers>
                    <next-states default="RECALLED"/>
                </event>

                <event name="ERROR" description="При работе с документом произошла ошибка" type="system">
                    <next-states default="ERROR"/>
                </event>
            </events>
        </state>

        <state id="UNKNOW" description="Статус документа не определен. Пожалуйста, обратитесь в Контактный центр банка для уточнения информации."
			   client-form="/private/payments/view.do"
               employee-form="/private/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="EXECUTE" description="Подтверждение документа сотрудником" type="employee">
                     <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="ERROR" description="Ошибка исполнения документа" type="system">
                    <next-states default="ERROR"/>
                </event>
            </events>
		</state>

        <state
			id="REFUSED" description="Вам отказано в исполнении операции по какой-либо причине."
			client-form="/private/payments/view.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

		<state
			id="RECALLED" description="Документ отозван Вами по какой-либо причине."
			client-form="/private/payments/view.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state
			id="EXECUTED" description="Автоплатеж успешно изменен"
			client-form="/private/payments/view.do"
            system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state
			id="ERROR" description="Платеж не может быть исполнен, Вам необходимо обратиться в банк."
			client-form="/private/payments/view.do"
			employee-form="/claims/claim.do"
            system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="EXECUTE" description="Подтверждение документа сотрудником" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="employee">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="EXECUTE" description="Подтверждение документа системой" type="system">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                    </handlers>
                    <next-states default="EXECUTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbExecuteDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа системой" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.ermb.handlers.ErmbRefuseDocumentHandler">
                                <enabled class="com.rssl.phizic.business.payments.forms.meta.DocumentCreationChannelFilter">
                                    <parameter name="whiteList" value="sms"/>
                                </enabled>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
		    </events>
        </state>

        <state id="DELETED" description="Документ удален."
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

    </states>

    <!-- Завяки на кредит, кредтную карту, предодобренный кредит и кредитную карту, виртуальную карту -->
    <states name="LoanOfferMachine" description="Машина состояний заявки на кредит, кредтную карту, предодобренный кредит и кредитную карту, виртуальную карту" inital-state="INITIAL" saveNodeInfo="true">
        <state id="INITIAL" client-form="/private/payments/payment.do"
               description="Частично заполеннный документ"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.forms.meta.LoanCardProductHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="LoanCardProduct"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.SetTransitionDateLoanCardOfferHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                        <parameter name="whiteList" value="LoanCardOfferClaim"/>
                    </enabled>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.SendPresentationInfoToCRMHandler">
                    <enabled class="com.rssl.phizic.business.payments.forms.meta.ApplicationIsApiFilter"/>
                </handler>
            </handlers>
            <events>
                <event name="SAVE" description="Сохранение документа клиентом"  type="client">
                     <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanOfferConvertHandler">
                            <parameter name="urlToRedirect" value="/private/payments/loan_product.do"/>
                            <parameter name="warning-message" value="Указанная Вами сумма кредита превышает сумму, предложенную банком. Для оформления предварительно одобренной заявки Вам нужно уменьшить сумму кредита. В противном случае Ваша заявка будет рассмотрена на общих условиях."/>
                                <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                    <parameter name="whiteList" value="LoanOffer"/>
                                </enabled>
                        </handler>

                     </handlers>
                    <next-states default="SAVED">
                    </next-states>
				</event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
             </events>
        </state>
        <state id="SAVED" client-form="/private/payments/confirm.do"
              description="Вы сохранили, но еще не подтвердили заявку."
              system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
				<event name="CONFIRM" description="Отправка документа клиентом" type="client" lock="true">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanProductHandler">
                            <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                                <parameter name="whiteList" value="LoanProduct;LoanCardProduct;LoanOffer;LoanCardOffer"/>
                            </enabled>
                        </handler>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <!-- проверка на актуальность предложения или продукта -->
                        <next-state
                                condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanCondition"
                                state="REFUSED"
                                client-message="По выбранному Вами кредиту изменились условия. Пожалуйста, создайте новую заявку"
                                description="По выбранному Вами кредиту изменились условия. Пожалуйста, создайте новую заявку">
                                <handlers>
                                    <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                                    <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                                </handlers>
                        </next-state>
                        <next-state
                                condition="com.rssl.phizic.business.payments.forms.meta.conditions.CardCondition"
                                state="REFUSED"
                                client-message="По выбранной Вами кредитной карте изменились условия. Пожалуйста, создайте новую заявку"
                                description="По выбранной Вами кредитной карте изменились условия. Пожалуйста, создайте новую заявку">
                                <handlers>
                                    <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                                    <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                                </handlers>
                        </next-state>
                        <next-state
                                condition="com.rssl.phizic.business.payments.forms.meta.conditions.VirtualCardClaimCondition"
                                state="REFUSED"
                                client-message="Условия по выбранной Вами виртуальной карте изменились. Пожалуйста, создайте новую заявку"
                                description="Условия по выбранной Вами виртуальной карте изменились. Пожалуйста, создайте новую заявку">
                                <handlers>
                                    <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                                    <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                                </handlers>
                        </next-state>

                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetReqistrationDateLoanCardOfferHandler"/>
                            <handler
                                 class="com.rssl.phizic.business.payments.forms.meta.RemoveLoanOfferHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                        </handlers>
                    </next-states>
                </event>
				<event name="EDIT" description="Редактирование документа" type="client">
                    <next-states default="INITIAL"/>
				</event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
			</events>
        </state>

        <state id="DISPATCHED" client-form="/private/payments/view.do"
               description="Заявка подтверждена и передана на обработку в банк."
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="ADOPT" description="Подтверждение документа системой" type="system">
                    <next-states default="ADOPTED"/>
                </event>

                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
            </events>

        </state>

        <state
			id="REFUSED" description="По выбранной Вами кредитной карте изменились условия. Пожалуйста, создайте новую заявку."
            client-form="/private/payments/view.do"
			system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state
			id="ADOPTED" description="Заявка принята."
			client-form="/private/payments/view.do"
            system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state id="DELETED" description="Документ удален."
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>
    </states>

    <!-- Расширенная заявка на кредит -->
    <states name="ExtendedLoanClaimMachine" description="Машина состояний расширенной заявки на кредит" inital-state="INITIAL" saveNodeInfo="true">
        <sequences-handlers>
            <sequence name="dispatched">
                <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimDispatchedStateNoticeHandler">
                    <parameter name="notice-type" value="SIMPLE"/>
                    <parameter name="notice-title" value="Отлично! Заявка отправлена на рассмотрение в Банк"/>
                </handler>
            </sequence>
            <sequence name="waited_tm">
                <handler class="com.rssl.phizic.business.payments.forms.meta.NoticeHandler">
                    <parameter name="notice-type" value="SIMPLE"/>
                    <parameter name="notice-title" value="Спасибо! Мы приняли вашу заявку"/>
                    <parameter name="notice-text" value="Требуется визит в отделение Банка для предоставления документов"/>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimInWaitTMHandler"/>
            </sequence>
            <sequence name="visited_to_office">
                <handler class="com.rssl.phizic.business.payments.forms.meta.NoticeHandler">
                    <parameter name="notice-type" value="VISIT"/>
                    <parameter name="notice-title" value="Требуется визит в отделение банка для предоставления документов"/>
                    <parameter name="notice-text" value="Требуется визит в отделение Банка для предоставления документов"/>
                </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.NewLoanClaimSendCRMMessageHandler"/>
            </sequence>
            <sequence name="approved">
                <handler class="com.rssl.phizic.business.payments.forms.meta.NoticeHandler">
                    <parameter name="notice-type" value="TICK"/>
                    <parameter name="notice-title" value="Кредит одобрен"/>
                    <parameter name="notice-text" value="Требуется визит в отделение Банка для предоставления документов"/>
                </handler>
            </sequence>
            <sequence name="refused">
                <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimMoratoriumCodeHandler">
                    <parameter name="notice-type" value="CANCEL"/>
                    <parameter name="notice-title" value="Заявка на кредит отклонена банком"/>
                    <parameter name="notice-text" value="Вы можете повторно подать заявку на кредит через 60 дней"/>
                </handler>
            </sequence>
        </sequences-handlers>
        <!--1.	Выбор кредита-->
        <state id="INITIAL" description="Черновик"
               client-form="/private/payments/payment.do"
               employee-form="/claim/payments/edit.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="SAVE" description="Сохранение документа клиентом" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimAvailabilityHandler"/>
                        <!--<handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimPersonAgeHandler"/>-->
                        <!--<handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimSbrfResourceHandler"/>-->
                        <!--<handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>-->
                    </handlers>
                    <next-states default="INITIAL2"/>
                </event>
                <event name="SAVE" description="Сохранение документа клиентом" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimAvailabilityHandler"/>
                        <!--<handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimPersonAgeHandler"/>-->
                        <!--<handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimSbrfResourceHandler"/>-->
                        <!--<handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>-->
                    </handlers>
                    <next-states default="INITIAL2"/>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="client">
                    <next-states default="INITIAL">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="employee">
                    <next-states default="INITIAL">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="NEED_VISIT_OFFICE" description="Требуется визит в отделение банка" type="employee">
                    <next-states default="VISIT_OFFICE">
                        <handlers>
                            <sequence-handlers-ref name="visited_to_office"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказан" type="employee">
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <sequence-handlers-ref name="refused"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DOWAITTM" description="В работе ТМ" type="employee">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <sequence-handlers-ref name="waited_tm"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ETSM_SEND" description="Отправка заявки в ETSM в ручном режиме" type="system" lock="true">
                    <!--TODO: При внесении изменений в данном событии, также не забыть поменять и в event-е "ETSM_SEND" других состояний заявки -->
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimVisitOfficeCondition" state="VISIT_OFFICE"/>
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireStateCondition" state="INITIAL8"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                        <!-- TODO: (Расширенная заявка на кредит) удаление предодобренного предложения на кредит. Исполнитель Еркин С. -->
                        <!--<handlers>-->
                            <!--<handler class="com.rssl.phizic.business.payments.forms.meta.RemoveLoanOfferHandler"/>-->
                        <!--</handlers>-->
                    </next-states>
                </event>
            </events>
        </state>

        <!--2.	Личные данные-->
        <state id="INITIAL2" description="Черновик"
               client-form="/private/payments/payment.do"
               employee-form="/claim/payments/edit.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="SAVE" description="Сохранение документа клиентом" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimPersonAgeHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimSbrfResourceHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimIsStepFillHandler"/>
                    </handlers>
                    <next-states default="INITIAL3"/>
                </event>
                <event name="SAVE" description="Сохранение документа клиентом" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimPersonAgeHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimSbrfResourceHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimIsStepFillHandler"/>
                    </handlers>
                    <next-states default="INITIAL3"/>
                </event>
                <event name="INITIAL" description="Изменение условий кредита" type="client">
                    <next-states default="INITIAL"/>
                </event>
                <event name="INITIAL" description="Изменение условий кредита" type="employee">
                    <next-states default="INITIAL"/>
                </event>
                <event name="EDIT" description="Редактирование документа" type="client">
                    <next-states default="INITIAL"/>
                </event>
                <event name="EDIT" description="Редактирование документа" type="employee">
                    <next-states default="INITIAL"/>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="client">
                    <next-states default="INITIAL2">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="employee">
                    <next-states default="INITIAL2">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="NEED_VISIT_OFFICE" description="Требуется визит в отделение банка" type="employee">
                    <next-states default="VISIT_OFFICE">
                        <handlers>
                            <sequence-handlers-ref name="visited_to_office"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказан" type="employee">
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <sequence-handlers-ref name="refused"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DOWAITTM" description="В работе ТМ" type="employee">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <sequence-handlers-ref name="waited_tm"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ETSM_SEND" description="Отправка заявки в ETSM в ручном режиме" type="system" lock="true">
                    <!--TODO: При внесении изменений в данном событии, также не забыть поменять и в event-е "ETSM_SEND" других состояний заявки -->
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimVisitOfficeCondition" state="VISIT_OFFICE"/>
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireStateCondition" state="INITIAL8"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                        <!-- TODO: (Расширенная заявка на кредит) удаление предодобренного предложения на кредит. Исполнитель Еркин С. -->
                        <!--<handlers>-->
                            <!--<handler class="com.rssl.phizic.business.payments.forms.meta.RemoveLoanOfferHandler"/>-->
                        <!--</handlers>-->
                    </next-states>
                </event>
            </events>
        </state>

        <!--3.	Семья-->
        <state id="INITIAL3" description="Черновик"
               client-form="/private/payments/payment.do"
               employee-form="/claim/payments/edit.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="SAVE" description="Сохранение документа клиентом" type="client">
                    <next-states default="INITIAL4">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimIsStepFillHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="SAVE" description="Сохранение документа клиентом" type="employee">
                    <next-states default="INITIAL4">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimIsStepFillHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="EDIT" description="Редактирование документа" type="client">
                    <next-states default="INITIAL2"/>
                </event>
                <event name="EDIT" description="Редактирование документа" type="employee">
                    <next-states default="INITIAL2"/>
                </event>
                <event name="INITIAL" description="Изменение условий кредита" type="client">
                    <next-states default="INITIAL"/>
                </event>
                <event name="INITIAL" description="Изменение условий кредита" type="employee">
                    <next-states default="INITIAL"/>
                </event>
                <event name="DOWAITTM" description="Заказать обратный звонок" type="client">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <sequence-handlers-ref name="waited_tm"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="client">
                    <next-states default="INITIAL3">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="employee">
                    <next-states default="INITIAL3">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="NEED_VISIT_OFFICE" description="Требуется визит в отделение банка" type="employee">
                    <next-states default="VISIT_OFFICE">
                        <handlers>
                            <sequence-handlers-ref name="visited_to_office"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказан" type="employee">
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <sequence-handlers-ref name="refused"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DOWAITTM" description="В работе ТМ" type="employee">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <sequence-handlers-ref name="waited_tm"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ETSM_SEND" description="Отправка заявки в ETSM в ручном режиме" type="system" lock="true">
                    <!--TODO: При внесении изменений в данном событии, также не забыть поменять и в event-е "ETSM_SEND" других состояний заявки -->
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimVisitOfficeCondition" state="VISIT_OFFICE"/>

                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireStateCondition" state="INITIAL8"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                        <!-- TODO: (Расширенная заявка на кредит) удаление предодобренного предложения на кредит. Исполнитель Еркин С. -->
                        <!--<handlers>-->
                            <!--<handler class="com.rssl.phizic.business.payments.forms.meta.RemoveLoanOfferHandler"/>-->
                        <!--</handlers>-->
                    </next-states>
                </event>
            </events>
        </state>

        <!--4.	Прописка-->
        <state id="INITIAL4" description="Черновик"
            client-form="/private/payments/payment.do"
            employee-form="/claim/payments/edit.do"
            system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="SAVE" description="Сохранение документа клиентом" type="client">
                    <next-states default="INITIAL5">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CheckCityAndLocalityHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimPersonResidenceDurationHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimIsStepFillHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="SAVE" description="Сохранение документа клиентом" type="employee">
                    <next-states default="INITIAL5">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CheckCityAndLocalityHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimPersonResidenceDurationHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimIsStepFillHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="EDIT" description="Редактирование документа" type="client">
                    <next-states default="INITIAL3"/>
                </event>
                <event name="EDIT" description="Редактирование документа" type="employee">
                    <next-states default="INITIAL3"/>
                </event>
                <event name="INITIAL" description="Изменение условий кредита" type="client">
                    <next-states default="INITIAL"/>
                </event>
                <event name="INITIAL" description="Изменение условий кредита" type="employee">
                    <next-states default="INITIAL"/>
                </event>
                <event name="DOWAITTM" description="Заказать обратный звонок" type="client">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <sequence-handlers-ref name="waited_tm"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="client">
                    <next-states default="INITIAL4">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="employee">
                    <next-states default="INITIAL4">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="NEED_VISIT_OFFICE" description="Требуется визит в отделение банка" type="employee">
                    <next-states default="VISIT_OFFICE">
                        <handlers>
                            <sequence-handlers-ref name="visited_to_office"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказан" type="employee">
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <sequence-handlers-ref name="refused"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DOWAITTM" description="В работе ТМ" type="employee">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <sequence-handlers-ref name="waited_tm"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ETSM_SEND" description="Отправка заявки в ETSM в ручном режиме" type="system" lock="true">
                    <!--TODO: При внесении изменений в данном событии, также не забыть поменять и в event-е "ETSM_SEND" других состояний заявки -->
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimVisitOfficeCondition" state="VISIT_OFFICE"/>

                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireStateCondition" state="INITIAL8"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                        <!-- TODO: (Расширенная заявка на кредит) удаление предодобренного предложения на кредит. Исполнитель Еркин С. -->
                        <!--<handlers>-->
                            <!--<handler class="com.rssl.phizic.business.payments.forms.meta.RemoveLoanOfferHandler"/>-->
                        <!--</handlers>-->
                    </next-states>
                </event>
            </events>
        </state>

        <!--5.	Работа и доход-->
        <state id="INITIAL5" description="Черновик"
               client-form="/private/payments/payment.do"
               employee-form="/claim/payments/edit.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="SAVE" description="Сохранение документа клиентом" type="client">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimTotalIncomeHandler"/>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimMaxPersonAgeHandler"/>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimMinJobExperience"/>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimIsStepFillHandler"/>
                    </handlers>
                    <next-states default="INITIAL6">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="SAVE" description="Сохранение документа клиентом" type="employee">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimTotalIncomeHandler"/>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimMaxPersonAgeHandler"/>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimMinJobExperience"/>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimIsStepFillHandler"/>
                    </handlers>
                    <next-states default="INITIAL6">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="EDIT" description="Редактирование документа" type="client">
                    <next-states default="INITIAL4"/>
                </event>
                <event name="EDIT" description="Редактирование документа" type="employee">
                    <next-states default="INITIAL4"/>
                </event>
                <event name="INITIAL" description="Изменение условий кредита" type="client">
                    <next-states default="INITIAL"/>
                </event>
                <event name="INITIAL" description="Изменение условий кредита" type="employee">
                    <next-states default="INITIAL"/>
                </event>
                <event name="DOWAITTM" description="Заказать обратный звонок" type="client">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <sequence-handlers-ref name="waited_tm"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="client">
                    <next-states default="INITIAL5">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="employee">
                    <next-states default="INITIAL5">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="NEED_VISIT_OFFICE" description="Требуется визит в отделение банка" type="employee">
                    <next-states default="VISIT_OFFICE">
                        <handlers>
                            <sequence-handlers-ref name="visited_to_office"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказан" type="employee">
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <sequence-handlers-ref name="refused"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DOWAITTM" description="В работе ТМ" type="employee">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <sequence-handlers-ref name="waited_tm"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ETSM_SEND" description="Отправка заявки в ETSM в ручном режиме" type="system" lock="true">
                    <!--TODO: При внесении изменений в данном событии, также не забыть поменять и в event-е "ETSM_SEND" других состояний заявки -->
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimVisitOfficeCondition" state="VISIT_OFFICE"/>

                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireStateCondition" state="INITIAL8"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                        <!-- TODO: (Расширенная заявка на кредит) удаление предодобренного предложения на кредит. Исполнитель Еркин С. -->
                        <!--<handlers>-->
                            <!--<handler class="com.rssl.phizic.business.payments.forms.meta.RemoveLoanOfferHandler"/>-->
                        <!--</handlers>-->
                    </next-states>
                </event>
            </events>
        </state>

        <!--6.	Собственность-->
        <state id="INITIAL6" description="Черновик"
               client-form="/private/payments/payment.do"
               employee-form="/claim/payments/edit.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="SAVE" description="Сохранение документа клиентом" type="client">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimRealtyHandler"/>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimIsStepFillHandler"/>
       				</handlers>
                    <next-states default="INITIAL7">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="SAVE" description="Сохранение документа клиентом" type="employee">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimRealtyHandler"/>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimIsStepFillHandler"/>
       				</handlers>
                    <next-states default="INITIAL7">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="EDIT" description="Редактирование документа" type="client">
                    <next-states default="INITIAL5"/>
                </event>
                <event name="EDIT" description="Редактирование документа" type="employee">
                    <next-states default="INITIAL5"/>
                </event>
                <event name="INITIAL" description="Изменение условий кредита" type="client">
                    <next-states default="INITIAL"/>
                </event>
                <event name="INITIAL" description="Изменение условий кредита" type="employee">
                    <next-states default="INITIAL"/>
                </event>
                <event name="DOWAITTM" description="Заказать обратный звонок" type="client">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <sequence-handlers-ref name="waited_tm"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="client">
                    <next-states default="INITIAL6">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="employee">
                    <next-states default="INITIAL6">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="NEED_VISIT_OFFICE" description="Требуется визит в отделение банка" type="employee">
                    <next-states default="VISIT_OFFICE"/>
                </event>
                <event name="REFUSE" description="Отказан" type="employee">
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <sequence-handlers-ref name="refused"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DOWAITTM" description="В работе ТМ" type="employee">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <sequence-handlers-ref name="waited_tm"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ETSM_SEND" description="Отправка заявки в ETSM в ручном режиме" type="system" lock="true">
                    <!--TODO: При внесении изменений в данном событии, также не забыть поменять и в event-е "ETSM_SEND" других состояний заявки -->
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimVisitOfficeCondition" state="VISIT_OFFICE"/>

                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireStateCondition" state="INITIAL8"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                        <!-- TODO: (Расширенная заявка на кредит) удаление предодобренного предложения на кредит. Исполнитель Еркин С. -->
                        <!--<handlers>-->
                            <!--<handler class="com.rssl.phizic.business.payments.forms.meta.RemoveLoanOfferHandler"/>-->
                        <!--</handlers>-->
                    </next-states>
                </event>
            </events>
        </state>

        <!--7.	Доп. информация-->
        <state id="INITIAL7"
               description="Черновик"
               client-form="/private/payments/payment.do"
               employee-form="/claim/payments/edit.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="SAVE" description="Сохранение документа клиентом" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimIsStepFillHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="INITIAL8">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireExistCondition" state="SAVED"/>
                    </next-states>
                </event>
                <event name="SAVE" description="Сохранение документа клиентом" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimIsStepFillHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="INITIAL8">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireExistCondition" state="SAVED"/>
                    </next-states>
                </event>
                <event name="EDIT" description="Редактирование документа" type="client">
                    <next-states default="INITIAL6"/>
                </event>
                <event name="EDIT" description="Редактирование документа" type="employee">
                    <next-states default="INITIAL6"/>
                </event>
                <event name="INITIAL" description="Изменение условий кредита" type="client">
                    <next-states default="INITIAL"/>
                </event>
                <event name="INITIAL" description="Изменение условий кредита" type="employee">
                    <next-states default="INITIAL"/>
                </event>
                <event name="DOWAITTM" description="Заказать обратный звонок" type="client">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <sequence-handlers-ref name="waited_tm"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="client">
                    <next-states default="INITIAL7">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="employee">
                    <next-states default="INITIAL7">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="NEED_VISIT_OFFICE" description="Требуется визит в отделение банка" type="employee">
                    <next-states default="VISIT_OFFICE">
                        <handlers>
                            <sequence-handlers-ref name="visited_to_office"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказан" type="employee">
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <sequence-handlers-ref name="refused"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DOWAITTM" description="В работе ТМ" type="employee">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <sequence-handlers-ref name="waited_tm"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ETSM_SEND" description="Отправка заявки в ETSM в ручном режиме" type="system" lock="true">
                    <!--TODO: При внесении изменений в данном событии, также не забыть поменять и в event-е "ETSM_SEND" других состояний заявки -->
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimVisitOfficeCondition" state="VISIT_OFFICE"/>

                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireStateCondition" state="INITIAL8"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                        <!-- TODO: (Расширенная заявка на кредит) удаление предодобренного предложения на кредит. Исполнитель Еркин С. -->
                        <!--<handlers>-->
                            <!--<handler class="com.rssl.phizic.business.payments.forms.meta.RemoveLoanOfferHandler"/>-->
                        <!--</handlers>-->
                    </next-states>
                </event>
            </events>
        </state>

        <!--8.	Анкета-->
        <state id="INITIAL8"
               description="Черновик"
               client-form="/private/payments/payment.do"
               employee-form="/claim/payments/edit.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="SAVE" description="Сохранение документа клиентом" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimIsStepFillHandler"/>
                    </handlers>
                    <next-states default="SAVED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="SAVE" description="Сохранение документа клиентом" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimIsStepFillHandler"/>
                    </handlers>
                    <next-states default="SAVED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="INITIAL" description="Изменение условий кредита" type="client">
                    <next-states default="INITIAL"/>
                </event>
                <event name="INITIAL" description="Изменение условий кредита" type="employee">
                    <next-states default="INITIAL"/>
                </event>
                <event name="EDIT" description="Редактирование документа" type="client">
                    <next-states default="INITIAL7"/>
                </event>
                <event name="EDIT" description="Редактирование документа" type="employee">
                    <next-states default="INITIAL7"/>
                </event>
                <event name="DOWAITTM" description="Заказать обратный звонок" type="client">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <sequence-handlers-ref name="waited_tm"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="INITIAL8">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireExistCondition" state="INITIAL7"/>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="INITIAL8">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireExistCondition" state="INITIAL7"/>
                    </next-states>
                </event>
                <event name="NEED_VISIT_OFFICE" description="Требуется визит в отделение банка" type="employee">
                    <next-states default="VISIT_OFFICE">
                        <handlers>
                            <sequence-handlers-ref name="visited_to_office"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказан" type="employee">
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <sequence-handlers-ref name="refused"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DOWAITTM" description="В работе ТМ" type="employee">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <sequence-handlers-ref name="waited_tm"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ETSM_SEND" description="Отправка заявки в ETSM в ручном режиме" type="system" lock="true">
                    <!--TODO: При внесении изменений в данном событии, также не забыть поменять и в event-е "ETSM_SEND" других состояний заявки -->
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimVisitOfficeCondition" state="VISIT_OFFICE"/>

                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireStateCondition" state="INITIAL8"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                        <!-- TODO: (Расширенная заявка на кредит) удаление предодобренного предложения на кредит. Исполнитель Еркин С. -->
                        <!--<handlers>-->
                            <!--<handler class="com.rssl.phizic.business.payments.forms.meta.RemoveLoanOfferHandler"/>-->
                        <!--</handlers>-->
                    </next-states>
                </event>
            </events>
        </state>

        <!--9.	Подтверждение заявки-->
        <state id="SAVED"
               client-form="/private/payments/extendedClaims/confirm.do"
               employee-form="/claim/payments/confirm.do"
               description="Введён"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="INITIAL" description="Изменение условий кредита" type="client">
                    <next-states default="INITIAL"/>
                </event>
                <event name="CONFIRM" description="Отправка документа клиентом" type="client" lock="true">
                    <!--TODO: При внесении изменений в данном событии, также не забыть поменять и в event-е "ETSM_SEND" других состояний заявки -->
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CompleteClaimFlagSettingHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChannelSettingHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimFindOfferHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimVisitOfficeCondition" state="VISIT_OFFICE">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.NewLoanClaimSendCRMMessageHandler"/>
                            </handlers>
                        </next-state>

                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireStateCondition" state="INITIAL8"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.NewLoanClaimSendCRMMessageHandler" />
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimMarkOfferAsUsedHandler"/>
                            <sequence-handlers-ref name="dispatched"/>
                        </handlers>
                        <!-- TODO: (Расширенная заявка на кредит) удаление предодобренного предложения на кредит. Исполнитель Еркин С. -->
                        <!--<handlers>-->
                            <!--<handler class="com.rssl.phizic.business.payments.forms.meta.RemoveLoanOfferHandler"/>-->
                        <!--</handlers>-->
                    </next-states>
                </event>
                <event name="CONFIRM" description="Отправка документа клиентом" type="employee" lock="true">
                    <!--TODO: При внесении изменений в данном событии, также не забыть поменять и в event-е "ETSM_SEND" других состояний заявки -->
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.CompleteClaimFlagSettingHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChannelSettingHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimFindOfferHandler"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimVisitOfficeCondition" state="VISIT_OFFICE">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.NewLoanClaimSendCRMMessageHandler"/>
                            </handlers>
                        </next-state>

                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireStateCondition" state="INITIAL8"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.NewLoanClaimSendCRMMessageHandler" />
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimMarkOfferAsUsedHandler"/>
                            <sequence-handlers-ref name="dispatched"/>
                        </handlers>
                        <!-- TODO: (Расширенная заявка на кредит) удаление предодобренного предложения на кредит. Исполнитель Еркин С. -->
                        <!--<handlers>-->
                            <!--<handler class="com.rssl.phizic.business.payments.forms.meta.RemoveLoanOfferHandler"/>-->
                        <!--</handlers>-->
                    </next-states>
                </event>
				<event name="EDIT" description="Редактирование документа" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="INITIAL8">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireExistCondition" state="INITIAL7"/>
                    </next-states>
				</event>
                <event name="UPGRADE" description="Актуализировать документ" type="client">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="SAVED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireStateCondition" state="INITIAL8"/>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="employee">
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="SAVED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireStateCondition" state="INITIAL8"/>
                    </next-states>
                </event>
                <event name="ETSM_SEND" description="Отправка заявки в ETSM в ручном режиме" type="system" lock="true">
                    <!--TODO: При внесении изменений в данном событии, также не забыть поменять и в event-е "ETSM_SEND" других состояний заявки-->
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimVisitOfficeCondition" state="VISIT_OFFICE"/>

                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireStateCondition" state="INITIAL8"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                        <!-- TODO: (Расширенная заявка на кредит) удаление предодобренного предложения на кредит. Исполнитель Еркин С. -->
                        <!--<handlers>-->
                            <!--<handler class="com.rssl.phizic.business.payments.forms.meta.RemoveLoanOfferHandler"/>-->
                        <!--</handlers>-->
                    </next-states>
                </event>
			</events>
        </state>

        <!--10.	Просмотр статуса заявки-->
        <state id="DISPATCHED" client-form="/private/payments/view.do"
               employee-form="/claim/payments/view.do"
               description="Обрабатывается"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="REFUSE" description="Отказ" type="system">
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <sequence-handlers-ref name="refused"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="ADOPT" description="Принятие предварительного решения" type="system">
                    <next-states default="PREADOPTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.NoticeHandler">
                                <parameter name="notice-type" value="BEFORE_TICK"/>
                                <parameter name="notice-title" value="Принято предварительное решение по заявке на кредит"/>
                                <parameter name="notice-text" value="Требуется визит в отделение Банка для предоставления документов"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="APPROVE" description="Одобрен" type="system">
                    <next-states default="APPROVED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <sequence-handlers-ref name="approved"/>
                        </handlers>
                    </next-states>
                </event>
                 <event name="APPROVE_MUST_CONFIRM" description="Одобрено, требуется подтверждение для выдачи" type="system">
                    <next-states default="APPROVED_MUST_CONFIRM">
                         <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <sequence-handlers-ref name="approved"/>
                        </handlers>
                    </next-states>
                </event>
            </events>
        </state>

        <state id="REFUSED" description="Отказан"
               client-form="/private/payments/view.do"
               employee-form="/claim/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
            </handlers>
            <events>
                <event name="DISPATCH" description="Обрабатывается" type="system">
                    <next-states default="DISPATCHED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="APPROVE" description="Одобрен" type="system">
                    <next-states default="APPROVED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <sequence-handlers-ref name="approved"/>
                        </handlers>
                    </next-states>
                </event>
                 <event name="APPROVE_MUST_CONFIRM" description="Одобрено, требуется подтверждение для выдачи" type="system">
                    <next-states default="APPROVED_MUST_CONFIRM">
                       <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <sequence-handlers-ref name="approved"/>
                        </handlers>
                    </next-states>
                </event>
            </events>
        </state>

        <state id="APPROVED" description="Кредит одобрен"
               client-form="/private/payments/view.do"
               employee-form="/claim/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="SUCCESS" description="Выдан" type="system">
                    <next-states default="ISSUED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.NoticeHandler">
                                <parameter name="notice-type" value="CREDIT_DONE"/>
                                <parameter name="notice-title" value="Кредит выдан"/>
                                <parameter name="notice-text" value="Спасибо, что воспользовались кредитом Сбербанка. Выплаты по кредиту удобно делать через Сбербанк Онлайн"/>
                            </handler>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.MonitoringDocumentHandler">
                                <parameter name="state" value="EXECUTED"/>
                            </handler>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказан" type="system">
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <sequence-handlers-ref name="refused"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="APPROVE_MUST_CONFIRM" description="Одобрено, требуется подтверждение для выдачи" type="system">
                    <next-states default="APPROVED_MUST_CONFIRM"/>
                </event>
            </events>
        </state>

        <state id="ISSUED" description="Кредит выдан"
               client-form="/private/payments/view.do"
               employee-form="/claim/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
            </handlers>
        </state>

        <state id="PREADOPTED" description="Принято предварительное решение"
               client-form="/private/payments/view.do"
               employee-form="/claim/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
            </handlers>
            <events>
                <event name="APPROVE_MUST_CONFIRM" description="Одобрено, требуется подтверждение для выдачи" type="system">
                    <next-states default="APPROVED_MUST_CONFIRM">
                         <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <sequence-handlers-ref name="approved"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="APPROVE" description="Одобрен" type="system">
                    <next-states default="APPROVED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <sequence-handlers-ref name="approved"/>
                        </handlers>
                    </next-states>
                </event>
            </events>
        </state>

        <state id="WAIT_TM" description="В работе ТМ"
               client-form="/private/payments/view.do"
               employee-form="/claim/payments/edit.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="DISPATCH" description="Обрабатывается" type="system">
                    <next-states default="DISPATCHED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.NewLoanClaimSendCRMMessageHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ" type="system">
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <sequence-handlers-ref name="refused"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="client">
                    <next-states default="WAIT_TM">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="UPGRADE" description="Актуализировать документ" type="employee">
                    <next-states default="INITIAL">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimGetOffersHandler"/>
                        </handlers>
                    </next-states>
                </event>
                 <event name="DISPATCH" description="Обрабатывается" type="employee">
                    <next-states default="DISPATCHED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.NewLoanClaimSendCRMMessageHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="NEED_VISIT_OFFICE" description="Визит в отделение" type="employee">
                    <next-states default="VISIT_OFFICE">
                        <handlers>
                            <sequence-handlers-ref name="visited_to_office"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="REFUSE" description="Отказ" type="employee">
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <sequence-handlers-ref name="refused"/>
                        </handlers>
                    </next-states>
                </event>
            </events>
        </state>

        <state id="VISIT_OFFICE" description="Передана в ВСП"
               client-form="/private/payments/view.do"
               employee-form="/claim/payments/view.do"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="UPGRADE" description="Актуализировать документ" type="client">
                    <next-states default="VISIT_OFFICE">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <!--В данном состоянии из CRM в ЕРИБ также возможен запрос на отправку заявки в ETSM. При этом, в случае успеха, заявка переходит в "DISPATCHED"-->
                <event name="ETSM_SEND" description="Отправка заявки в ETSM в ручном режиме" type="system" lock="true">
                    <!--TODO: При внесении изменений в данном событии, также не забыть поменять и в event-е "ETSM_SEND" других состояний заявки-->
                    <handlers>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.DefaultBusinessDocumentSender"/>
                        <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimQuestionnaireUpgradeHandler"/>
                    </handlers>
                    <next-states default="DISPATCHED">
                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimVisitOfficeCondition" state="VISIT_OFFICE"/>

                        <next-state condition="com.rssl.phizic.business.payments.forms.meta.conditions.LoanClaimQuestionnaireStateCondition" state="INITIAL8"/>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                        </handlers>
                        <!-- TODO: (Расширенная заявка на кредит) удаление предодобренного предложения на кредит. Исполнитель Еркин С. -->
                        <!--<handlers>-->
                            <!--<handler class="com.rssl.phizic.business.payments.forms.meta.RemoveLoanOfferHandler"/>-->
                        <!--</handlers>-->
                    </next-states>
                </event>
            </events>
        </state>

        <state id="APPROVED_MUST_CONFIRM"  description="Одобрено, требуется подтверждение для выдачи" client-form="/private/payments/payment.do" system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver" >
            <events>
                <event name="CONFIRM" description="Ожидание выдачи кредита"  type="client">
                   <next-states default="OFFER_DISPATCHED">
                        <!-- проверка на актуальность предложения или продукта -->
                    </next-states>
				</event>
                <event name="REFUSE" description="Отказано банком" type="system">
                    <next-states default="REFUSED">
                    </next-states>
                </event>
             </events>
        </state>

        <state id="OFFER_DISPATCHED" description="Отправка акцепта оферты в Банк" client-form="/private/payments/view.do" system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver" >
            <events>
                <event name="ADOPT" description="Акцептовано, ожидание выдачи кредита" type="system">
                    <next-states default="ACCEPTED_WAIT_DELIVERY">
                    </next-states>
                </event>

                <event name="ERROR" description="Ошибка из ETSM" type="system">
                    <next-states default="APPROVED_MUST_CONFIRM">
                    </next-states>
                </event>
            </events>
        </state>

        <state id="ACCEPTED_WAIT_DELIVERY" description="Акцептовано, ожидание выдачи кредита"    client-form="/private/payments/view.do" system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="ADOPT" description="Кредит выдан" type="system">
                    <next-states default="ISSUED">
                    </next-states>
                </event>
                 <event name="REFUSE" description="Отказ" type="system">
                    <next-states default="REFUSED">
                    </next-states>
                </event>
                <event name="TRANSFERT_IMPOSSIBLE" description="Ошибка из ETSM(Данный переход выполняется в случае невозможности перечислить  клиенту кредитные средства по причине того, что указанный счет для выдачи на текущий момент закрыт.)" type="system">
                    <next-states default="VISIT_REQUIRED">
                    </next-states>
                </event>
            </events>
        </state>

        <state id="VISIT_REQUIRED" description="Необходим визит в отделение"  system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver" client-form="/private/payments/view.do">
            <events>
                <event name="ADOPT" description="Кредит выдан" type="system">
                    <next-states default="ISSUED">
                    </next-states>
                </event>
                 <event name="REFUSE" description="Отказ" type="system">
                    <next-states default="REFUSED">
                    </next-states>
                </event>
            </events>
        </state>
    </states>

    <states name="ShortLoanClaimMachine" description="Машина состояний короткой заявки на кредит" inital-state="INITIAL" saveNodeInfo="true">

        <state id="INITIAL"
               client-form="/private/payments/payment.do"
               description="Частично заполненный документ"
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <handlers>
               <handler class="com.rssl.phizic.business.payments.forms.meta.ShortLoanClaimAccessHandler">
                    <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                       <parameter name="whiteList" value="ShortLoanClaim"/>
                   </enabled>
               </handler>
               <handler class="com.rssl.phizic.business.payments.forms.meta.ExtendedLoanClaimAccessHandler">
                   <enabled class="com.rssl.phizic.business.documents.payments.handlers.DocumentFormNameHandlerFilter">
                       <parameter name="whiteList" value="ShortLoanClaim"/>
                   </enabled>
               </handler>
                <handler class="com.rssl.phizic.business.payments.forms.meta.SendPresentationInfoToCRMHandler">
                    <enabled class="com.rssl.phizic.business.payments.forms.meta.ApplicationIsApiFilter"/>
                </handler>
            </handlers>

            <events>
                <event name="SAVE" description="Сохранение документа клиентом"  type="client">
                    <next-states default="SAVED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>

                        </handlers>
                    </next-states>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED"/>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED"/>
                </event>
            </events>
        </state>

       <state id="SAVED" client-form="/private/payments/confirm.do"
           description="Вы сохранили, но еще не подтвердили заявку."
           system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
                <events>
                    <event name="CONFIRM" description="Отправка документа клиентом" type="client" lock="true">
                        <next-states default="DISPATCHED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.LoanClaimChangeConditionHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.receivers.RemoveShortClaimLoanOfferHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                            </handlers>
                        </next-states>
                    </event>
                    <event name="EDIT" description="Редактирование документа" type="client">
                        <next-states default="INITIAL"/>
                    </event>
                    <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                        <handlers>
                             <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
                        </handlers>
                        <next-states default="REFUSED">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            </handlers>
                        </next-states>
                    </event>
                    <event name="DELETE" description="Удалить документ" type="client">
                        <next-states default="DELETED"/>
                    </event>
                    <event name="DELETE" description="Удалить документ" type="system">
                        <next-states default="DELETED"/>
                    </event>
                </events>
           </state>

       <state id="DISPATCHED" client-form="/private/payments/view.do"
                   description="Заявка подтверждена и передана на обработку в банк."
                   system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">
            <events>
                <event name="ADOPT" description="Подтверждение документа системой" type="system">
                    <next-states default="ADOPTED"/>
                </event>
                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
            </events>
        </state>

       <state id="REFUSED" client-form="/private/payments/view.do"
              description="По выбранной Вами кредитной карте изменились условия. Пожалуйста, создайте новую заявку."
              system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

       <state id="ADOPTED" client-form="/private/payments/view.do"
              description="Заявка принята."
              system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

       <state id="DELETED" description="Документ удален."
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>
    </states>

    <states name="LoanCardClaimMachine" description="Машина состояний заявки на кредит, кредтную карту, предодобренный кредит и кредитную карту, виртуальную карту" inital-state="INITIAL" saveNodeInfo="true">
        <state id="INITIAL" client-form="/private/payments/payment.do" system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver" description="Частично заполеннный документ">
            <handlers>
                <handler class="com.rssl.phizic.business.payments.forms.meta.LoanCardClaimHandler"/>
                <handler class="com.rssl.phizic.business.payments.forms.meta.SetTransitionDateLoanCardOfferHandler"/>
                <handler class="com.rssl.phizic.business.payments.forms.meta.SendPresentationInfoToCRMHandler">
                    <enabled class="com.rssl.phizic.business.payments.forms.meta.ApplicationIsApiFilter"/>
                </handler>
            </handlers>
            <events>
                <event name="SAVE" description="Сохранение документа клиентом"  type="client">
                   <next-states default="DISPATCHED">
                        <!-- проверка на актуальность предложения или продукта -->
                        <next-state state="REFUSED" condition="com.rssl.phizic.business.payments.forms.meta.conditions.CardCondition"
                                    client-message="По выбранной Вами кредитной карте изменились условия. Пожалуйста, создайте новую заявку"
                                    description="По выбранной Вами кредитной карте изменились условия. Пожалуйста, создайте новую заявку">
                            <handlers>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                                <handler class="com.rssl.phizic.business.payments.forms.meta.SaveDocumentStateInHistoryHandler"/>
                            </handlers>
                        </next-state>
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetReqistrationDateLoanCardOfferHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.RemoveLoanOfferHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.PostUpdateDocumentHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CacheClearHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanCardClaimFillHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanCardClaimPersonDataUpdateHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SaveDocumentStateInHistoryHandler"/>
                            <handler class="com.rssl.phizic.messaging.payments.handlers.LoanCardClaimAdoptedHandler"/>
                        </handlers>
                    </next-states>
				</event>
                 <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SaveDocumentStateInHistoryHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DELETE" description="Удалить документ" type="client">
                    <next-states default="DELETED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SaveDocumentStateInHistoryHandler"/>
                        </handlers>
                    </next-states>
                </event>
                <event name="DELETE" description="Удалить документ" type="system">
                    <next-states default="DELETED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SaveDocumentStateInHistoryHandler"/>
                        </handlers>
                    </next-states>
                </event>
             </events>
        </state>

        <state id="DISPATCHED" client-form="/private/payments/view.do" system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver" description="Заявка подтверждена и передана на обработку в банк.">
            <events>
                <event name="ADOPT" description="Подтверждение документа системой" type="system">
                    <next-states default="ADOPTED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.LoanCardClaimPersonDataUpdateHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SaveDocumentStateInHistoryHandler"/>
                        </handlers>
                    </next-states>
                </event>

                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SaveDocumentStateInHistoryHandler"/>
                        </handlers>
                    </next-states>
                </event>
            </events>
        </state>

        <state id="REFUSED" description="По выбранной Вами кредитной карте изменились условия. Пожалуйста, создайте новую заявку."    client-form="/private/payments/view.do" system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>
        <state id="ADOPTED" description="Заявка принята."  system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver" client-form="/private/payments/view.do"/>
        <state id="DELETED" description="Документ удален." system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>
    </states>

    <states name="PreapprovedLoanCardClaimMachine" description="Машина состояний заявки на кредит, кредтную карту, предодобренный кредит и кредитную карту, виртуальную карту" inital-state="DISPATCHED" saveNodeInfo="true">
        <state id="DISPATCHED" client-form="/private/payments/view.do"
               description="Заявка подтверждена и передана на обработку в банк."
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver">

            <events>
                <event name="ADOPT" description="Подтверждение документа системой" type="system">
                    <next-states default="ADOPTED"/>
                </event>

                <event name="REFUSE" description="Отказ в исполнении документа" type="system">
                    <handlers>
                         <handler class="com.rssl.phizic.business.payments.forms.meta.SetExecutionDateHandler"/>
       				</handlers>
                    <next-states default="REFUSED">
                        <handlers>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.SetClientMessageKey"/>
                            <handler class="com.rssl.phizic.business.payments.forms.meta.CreateNotificationHandler"/>
                        </handlers>
                    </next-states>
                </event>
            </events>
        </state>

        <state
                id="REFUSED" description="По выбранной Вами кредитной карте изменились условия. Пожалуйста, создайте новую заявку."
                client-form="/private/payments/view.do"
                system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state
                id="ADOPTED" description="Заявка принята."
                client-form="/private/payments/view.do"
                system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

        <state id="DELETED" description="Документ удален."
               system-resolver="com.rssl.phizic.business.payments.ERIBSystemNameResolver"/>

    </states>
</config>
