<?xml version="1.0"?>
<access-rules xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                      xsi:noNamespaceSchemaLocation="./../../schemas/authenticationModes.xsd">
	<simple-rule>
		<description>Политика доступа клиентов в "Сбербанк Онлайн"</description>
        <!-- Режим аутентификации для стандартного входа -->
		<authentication-mode user-visiting-mode="basic">
			<stage>
				<key>lp</key>
                <!-- URL для входа через старое ЦСА.-->
				<allow-action>/login.do</allow-action>
                <!-- URL для входя через ЦСА нашей разработки.-->
                <allow-action>/CSAFrontLogin.do</allow-action>
			</stage>
            <stage>
                <key>api</key>
                <allow-action>/updateAPI.do</allow-action>
            </stage>
            <stage>
                <key>updatePersonData</key>
                <allow-action>/updatePersonData.do</allow-action>
                <demand-if>
                    <class>com.rssl.phizic.auth.modes.SynchProfileInfoStageVerifier</class>
                </demand-if>
            </stage>
            <stage>
                <key>departmentsp</key>
                <allow-action>/login/departments.do</allow-action>
                <demand-if>
                    <class>com.rssl.phizic.auth.modes.ChooseDepartmentStageVerifier</class>
                </demand-if>
            </stage>
            <stage>
                <key>needSelfRegistration</key>
                <allow-action>/login/self-registration.do</allow-action>
                <allow-action>/login/async/self-registration.do</allow-action>
                <allow-action>/login/login-error.do</allow-action>
                <allow-action>/CSAFrontLogin.do</allow-action>
            </stage>
            <stage>
                <key>registerMobileBank</key>
                <allow-action>/login/register-mobilebank/start.do</allow-action>
                <allow-action>/login/register-mobilebank/edit.do</allow-action>
                <allow-action>/login/register-mobilebank/confirm.do</allow-action>
                <allow-action>/async/login/register-mobilebank/confirm.do</allow-action>
                <allow-action>/login/register-mobilebank/view.do</allow-action>
                <allow-operation>
                    <operation-class>StartMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <allow-operation>
                    <operation-class>EditMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <allow-operation>
                    <operation-class>ConfirmMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <allow-operation>
                    <operation-class>ViewMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <demand-if>
                    <class>com.rssl.phizic.business.ext.sbrf.mobilebank.RegisterMobileBankStageVerifier</class>
                </demand-if>
            </stage>
			<stage>
				<key>smsp</key>
				<allow-action>/confirm/way4.do</allow-action>
                <allow-action>/async/confirm.do</allow-action>
                <allow-action>/login/register-mobilebank/start.do</allow-action>
                <allow-action>/login/register-mobilebank/edit.do</allow-action>
                <allow-action>/login/register-mobilebank/confirm.do</allow-action>
                <allow-action>/async/login/register-mobilebank/confirm.do</allow-action>
                <allow-action>/login/register-mobilebank/view.do</allow-action>
                <allow-operation>
                    <operation-class>CheckCapConfirmAccessOperation</operation-class>
                    <allow-if>com.rssl.phizic.operations.access.verifier.CapAllowOperationVerifier</allow-if>
                </allow-operation>
                <allow-operation>
                    <operation-class>CheckPushConfirmAccessOperation</operation-class>
                    <allow-if>com.rssl.phizic.operations.access.verifier.PushAllowOperationVerifier</allow-if>
                </allow-operation>
                <allow-operation>
                    <operation-class>StartMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <allow-operation>
                    <operation-class>EditMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <allow-operation>
                    <operation-class>ConfirmMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <allow-operation>
                    <operation-class>ViewMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <demand-if>
					<class>com.rssl.phizic.auth.modes.KeyStageVerifier</class>
					<parameter>
						<name>property</name>
						<value>simple-auth-choice</value>
					</parameter>
				</demand-if>
			</stage>
            <!-- Если пароль пользователя устарел, выполняется этот этап авторизации. -->
            <stage>
                <key>oldPassword</key>
                <allow-action>/login/checkOldPassword.do</allow-action>
                <allow-action>/login/async/checkOldPassword.do</allow-action>
                <allow-operation>
                    <operation-class>ChangeClientPasswordOperation</operation-class>
                </allow-operation>
            </stage>
            <stage>
                <key>internetSecurityp</key>
                <allow-action>/internetSecurity.do</allow-action>
                <allow-operation>
                    <operation-class>ChangeUseInternetSecurityOperation</operation-class>
                </allow-operation>
                <demand-if>
                    <class>com.rssl.phizic.business.persons.NeedUseInternetSecurityVerifier</class>
                </demand-if>
            </stage>
            <stage>
                <key>regionp</key>
                <allow-action>/region.do</allow-action>
                <allow-action>/dictionaries/regions/list.do</allow-action>
                <allow-operation>
                    <service-key>RegionsList</service-key>
                    <operation-class>RegionsListOperation</operation-class>
                </allow-operation>
                <allow-operation>
                    <operation-class>UpdateRegionFromCSAOperation</operation-class>
                </allow-operation>
            </stage>
            <stage>
                <key>ofertp</key>
                <allow-action>/ofert.do</allow-action>
                <allow-operation>
                    <operation-class>ChangeUseOfertOperation</operation-class>
                </allow-operation>
                <demand-if>
                    <class>com.rssl.phizic.business.persons.NeedUseOfertVerifier</class>
                </demand-if>
            </stage>
            <stage>
                <key>showContactsMessage</key>
                <allow-action>/showContactsMessage.do</allow-action>
                <allow-operation>
                    <operation-class>ShowContactsMessageOperation</operation-class>
                </allow-operation>
                <demand-if>
                    <class>com.rssl.phizic.business.contacts.NeedShowContactsMessageVerifier</class>
                </demand-if>
            </stage>
			<on-complete>
                <action>com.rssl.phizic.business.security.auth.ClientAthenticationCompleteAction</action>
                <action>com.rssl.phizic.web.common.client.ext.sbrf.SetupPersonContextFieldsAction</action>
                <action>com.rssl.ikfl.crediting.ClientAthenticationCompleteAction</action>
                <action>com.rssl.phizic.web.common.client.ext.sbrf.resources.AddOrUpdateClientResourcesAction</action>
                <action>com.rssl.phizic.web.common.client.ext.sbrf.resources.UpdateClientResourcesViewsAction</action>
                <action>com.rssl.phizic.web.common.client.ext.sbrf.YoungPeopleGroupCompleteAction</action>
                <action>com.rssl.phizic.web.common.client.widget.LoadWidgetsAction</action>
                <action>com.rssl.phizic.web.common.client.ext.sbrf.resources.AddOrUpdateClientTarifPlanCodeType</action>
                <action>com.rssl.phizic.web.common.client.ext.sbrf.limits.ReplicateDocumentOperationsCompleteAction</action>
                <action>com.rssl.phizic.web.common.client.ext.sbrf.products.UpdateClientSettingsAction</action>
                <action>com.rssl.phizic.web.common.client.ext.sbrf.resources.OnLoginUpdateUserPropertiesAction</action>
                <action>com.rssl.phizic.messaging.ext.sbrf.UserLogonNotificationAction</action>
                <action>com.rssl.phizic.web.common.client.rsa.OnLoginSendRSARequestAction</action>
            </on-complete>

		</authentication-mode>

        <!-- Режим аутентификации для оплаты платёжных поручений (ФНС/OZON) -->
        <authentication-mode user-visiting-mode="payorder_payment">
            <stage>
                <key>lp</key>
                <!-- URL для редиректа из ЦСА нашей разработки для перехода с внешней ссылки.-->
                <allow-action>/front/payOrderPaymentLogin.do</allow-action>
            </stage>
            <stage>
                <key>api</key>
                <allow-action>/updateAPI.do</allow-action>
            </stage>
            <stage>
                <key>departmentsp</key>
                <allow-action>/login/departments.do</allow-action>
                <demand-if>
                    <class>com.rssl.phizic.auth.modes.ChooseDepartmentStageVerifier</class>
                </demand-if>
            </stage>
            <stage>
                <key>registerMobileBank</key>
                <allow-action>/login/register-mobilebank/start.do</allow-action>
                <allow-action>/login/register-mobilebank/edit.do</allow-action>
                <allow-action>/login/register-mobilebank/confirm.do</allow-action>
                <allow-action>/async/login/register-mobilebank/confirm.do</allow-action>
                <allow-action>/login/register-mobilebank/view.do</allow-action>
                <allow-operation>
                    <operation-class>StartMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <allow-operation>
                    <operation-class>EditMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <allow-operation>
                    <operation-class>ConfirmMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <allow-operation>
                    <operation-class>ViewMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <demand-if>
                    <class>com.rssl.phizic.business.ext.sbrf.mobilebank.RegisterMobileBankStageVerifier</class>
                </demand-if>
            </stage>
            <stage>
                <key>smsp</key>
                <allow-action>/confirm/way4.do</allow-action>
                <allow-action>/async/confirm.do</allow-action>
                <allow-action>/login/register-mobilebank/start.do</allow-action>
                <allow-action>/login/register-mobilebank/edit.do</allow-action>
                <allow-action>/login/register-mobilebank/confirm.do</allow-action>
                <allow-action>/async/login/register-mobilebank/confirm.do</allow-action>
                <allow-action>/login/register-mobilebank/view.do</allow-action>
                <allow-operation>
                    <operation-class>CheckPushConfirmAccessOperation</operation-class>
                    <allow-if>com.rssl.phizic.operations.access.verifier.PushAllowOperationVerifier</allow-if>
                </allow-operation>
                <allow-operation>
                    <operation-class>StartMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <allow-operation>
                    <operation-class>EditMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <allow-operation>
                    <operation-class>ConfirmMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <allow-operation>
                    <operation-class>ViewMobileBankRegistrationOperation</operation-class>
                </allow-operation>
                <demand-if>
                    <class>com.rssl.phizic.auth.modes.KeyStageVerifier</class>
                    <parameter>
                        <name>property</name>
                        <value>simple-auth-choice</value>
                    </parameter>
                </demand-if>
            </stage>
            <stage>
                <key>oldPassword</key>
                <allow-action>/login/checkOldPassword.do</allow-action>
                <allow-operation>
                    <operation-class>com.rssl.phizic.operations.userprofile.ChangeClientPasswordOperation</operation-class>
                </allow-operation>
            </stage>
            <stage>
                <key>regionp</key>
                <allow-action>/region.do</allow-action>
                <allow-action>/dictionaries/regions/list.do</allow-action>
                <allow-operation>
                    <service-key>RegionsList</service-key>
                    <operation-class>RegionsListOperation</operation-class>
                </allow-operation>
                <allow-operation>
                    <operation-class>UpdateRegionFromCSAOperation</operation-class>
                </allow-operation>
                <demand-if>
                    <class>com.rssl.phizic.business.persons.NeedToSelectRegionVerifier</class>
                </demand-if>
            </stage>
            <on-complete>
                <action>com.rssl.phizic.business.security.auth.ClientAthenticationCompleteAction</action>
                <action>com.rssl.ikfl.crediting.ClientAthenticationCompleteAction</action>
                <action>com.rssl.phizic.web.common.client.ext.sbrf.resources.AddOrUpdateClientResourcesAction</action>
                <action>com.rssl.phizic.web.common.client.ext.sbrf.YoungPeopleGroupCompleteAction</action>
                <action>com.rssl.phizic.web.common.client.widget.LoadWidgetsAction</action>
                <action>com.rssl.phizic.web.ext.sbrf.payments.ProcessExternalPaymentCompleteAction</action>
                <action>com.rssl.phizic.web.common.client.ext.sbrf.resources.AddOrUpdateClientTarifPlanCodeType</action>
                <action>com.rssl.phizic.web.common.client.ext.sbrf.products.UpdateClientSettingsAction</action>
                <action>com.rssl.phizic.messaging.ext.sbrf.UserLogonNotificationAction</action>
                <action>com.rssl.phizic.web.common.client.rsa.OnLoginSendRSARequestAction</action>
            </on-complete>
        </authentication-mode>

		<confirmation-mode>
			<key-property>secure-confirm-choice</key-property>
			<strategy>
				<key>smsp</key>
				<compas>
                    <default>true</default>
                    <strategy>com.rssl.phizic.auth.modes.iPasSmsPasswordConfirmStrategy</strategy>
                </compas>
				<compas>
                    <strategy>com.rssl.phizic.auth.modes.iPasPasswordCardConfirmStrategy</strategy>
                </compas>
                <compas>
                    <strategy>com.rssl.phizic.operations.ext.sbrf.strategy.iPasCapConfirmStrategy</strategy>
                </compas>
                <compas>
                    <strategy>com.rssl.phizic.auth.modes.PushPasswordConfirmStrategy</strategy>
                </compas>
			</strategy>
            <strategy>
				<key>cryptoLike</key>
                <compas>
                    <default>true</default>
                    <strategy>com.rssl.phizic.auth.modes.iPasSmsPasswordConfirmStrategy</strategy>
                </compas>
				<compas>
                    <strategy>com.rssl.phizic.auth.modes.iPasPasswordCardConfirmStrategy</strategy>
                </compas>
                <compas>
                    <strategy>com.rssl.phizic.operations.ext.sbrf.strategy.iPasCapConfirmStrategy</strategy>
                </compas>
                <compas>
                    <strategy>com.rssl.phizic.auth.modes.PushPasswordConfirmStrategy</strategy>
                </compas>
			</strategy>
		</confirmation-mode>

		<authentication-choice>
			<property>simple-auth-choice</property>
			<option>
				<name>Без подтверждения</name>
				<value>lp</value>
			</option>
			<option>
				<name>смс-пароль или пароль с чека</name>
				<value>smsp</value>
			</option>
		</authentication-choice>

		<confirmation-choice>
			<property>secure-confirm-choice</property>
            <option>
                <name>смс-пароль или пароль с чека</name>
                <value>smsp</value>
            </option>
		</confirmation-choice>
	</simple-rule>

    <anonymous-rule>
		<description>Анонимный доступ</description>
		<confirmation-mode>
			<strategy>
				<key>cap</key>
				<class>com.rssl.phizic.auth.modes.CaptchaConfirmStrategy</class>
			</strategy>
		</confirmation-mode>
	</anonymous-rule>

    <guest-rule>
        <description>Гостевой входа</description>
        <authentication-mode user-visiting-mode="guest">
            <stage>
                <key>lp</key>
                <!-- URL для входа через ЦСА для гостей -->
                <allow-action>/CSAFrontGuestLogin.do</allow-action>
            </stage>
            <stage>
                <key>guestPersonData</key>
                <allow-action>/guestPersonData.do</allow-action>
                <demand-if>
                    <class>com.rssl.phizic.business.security.auth.GuestMobileBankExist</class>
                </demand-if>
            </stage>
            <on-complete>
                <action>com.rssl.phizic.business.security.auth.GuestAuthenticationCompleteAction</action>
                <action>com.rssl.ikfl.crediting.ClientAthenticationCompleteAction</action>
                <action>com.rssl.phizic.business.security.auth.GuestLoadCardsAction</action>
            </on-complete>
        </authentication-mode>
		<confirmation-mode>
            <key-property>secure-confirm-guest</key-property>
			<strategy>
				<key>smsp</key>
				<class>com.rssl.phizic.auth.modes.iPasSmsPasswordConfirmStrategy</class>
			</strategy>
		</confirmation-mode>
	</guest-rule>
</access-rules>
